<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>One Click Planner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
body {
  font-family: 'Segoe UI', Roboto, sans-serif;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(to bottom right, #0a0f1f, #1a2b55); /* deep navy to rich blue */
  color: #f1f1f1;
  overflow-x: hidden;
  scroll-behavior: smooth;
}

#typewriter-text::after {
  content: '|';
  animation: blink 0.8s infinite;
  margin-left: 2px;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50%      { opacity: 0; }
}

/* Animate just the logo image */
.logo-img {
  width: 80px;
  height: auto;
  border-radius: 12px;
  object-fit: contain;
  background-color: transparent;
  animation: clickBounce 0.4s ease-out 1.2s forwards;
  transform-origin: center;
}


@keyframes clickBounce {
  0%   { transform: scale(1); }
  30%  { transform: scale(0.9); }
  60%  { transform: scale(1.05); }
  100% { transform: scale(1); }
}


.navbar {
  background-color: rgba(15, 15, 20, 0.6) !important;
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  transition: background-color 0.4s ease;
}

/* Animate navbar brand (logo + text) */
.navbar-brand {
  opacity: 0;
  font-size: 2rem;
  font-weight: 700;
  color: #4db8ff !important;
  text-shadow: 0 0 10px #5b0fd688;
  animation: floatInGlow 1.2s ease-out forwards;
  animation-delay: 0.3s;
  transform: translateY(-10px) scale(0.95);
}
/* Keyframes */
@keyframes floatInGlow {
  0% {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    text-shadow: 0 0 0 transparent;
  }
  70% {
    opacity: 1;
    transform: translateY(2px) scale(1.03);
    text-shadow: 0 0 14px #4db8ff88;
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
    text-shadow: 0 0 10px #5b0fd688;
  }
}


/* Glow underline animation for nav links */
.nav-link {
  color: #fff !important;
  position: relative;
  padding: 0.5rem 1rem;
  font-weight: 500;
  transition: color 0.3s ease;
}

.nav-link::after {
  content: '';
  position: absolute;
  left: 10%;
  bottom: 5px;
  width: 80%;
  height: 2px;
  background: #7409f0;
  transform: scaleX(0);
  transform-origin: center;
  transition: transform 0.3s ease;
}

.nav-link::after {
  background: #ff1f4b;
}


.nav-link:hover {
  color: #ff1f4b !important;
  text-shadow: 0 0 10px #ff1f4baa;
}


.hero-section {
  background: linear-gradient(rgba(10, 10, 10, 0.6), rgba(10, 10, 10, 0.6)),
              url('https://source.unsplash.com/1600x900/?travel,landscape');
  background-size: cover;
  background-position: center;
  color: white;
  padding: 100px 0;
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
}

.hero-section h1 {
  font-size: 3.5rem;
  animation: fadeInDown 1s ease-out;
}

.hero-section p {
  font-size: 1.4rem;
  opacity: 0.9;
  animation: fadeInUp 1.2s ease-out;
}



.planning-card {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(16px);
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease-in-out;
}

input, .form-control, .btn {
  border-radius: 10px !important;
}

.btn-primary {
  background: linear-gradient(135deg, #00c6ff, #0072ff);
  border: none;
  font-weight: 600;
  box-shadow: 0 6px 20px rgba(0, 114, 255, 0.5);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.btn-primary:hover {
  transform: scale(1.06);
  box-shadow: 0 8px 28px rgba(0, 114, 255, 0.7);
}

.btn-outline-light {
  border-color: #fff;
  color: #fff;
  transition: all 0.s ease;
}

.btn-outline-light:hover {
  background-color: #ff1f4b !important;
  color: white !important;
  border-color: #ff1f4b !important;
  box-shadow: 0 0 12px #ff1f4b, 0 0 24px #ff1f4baa;
}


.feature-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
  transition: transform 0.4s ease, box-shadow 0.4s ease, border-color 0.4s ease;
  position: relative;
  z-index: 1;
  perspective: 1000px;
}

.feature-card:hover {
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 0 16px rgba(255, 31, 75, 0.4), 0 0 40px rgba(255, 31, 75, 0.3);
  border-color: #ff1f4b88;
  transform: rotateY(3deg) scale(1.03);
}


.feature-icon {
  font-size: 3rem;
  color: #00e0ff;
  filter: drop-shadow(0 0 10px #00e0ff88);
  transition: transform 0.3s ease, filter 0.3s ease;
}


footer {
  background-color: #111;
  color: #ccc;
  padding: 30px 0;
  font-size: 0.9rem;
  border-top: 1px solid rgba(255, 255, 255, 0.07);
}

/* Category buttons */
.btn-attractions, .btn-restaurants, .btn-itinerary {
  font-weight: 600;
  padding: 0.5rem 1.25rem;
  transition: all 0.3s ease;
  cursor: pointer;
  box-shadow: 0 0 4px transparent;
}

/* Base glow */
.btn-attractions {
  border: 2px solid #ff6f61;
  color: #ff6f61;
  box-shadow: 0 0 6px #ff6f6155;
}

.btn-restaurants {
  border: 2px solid #ffcc00;
  color: #ffcc00;
  box-shadow: 0 0 6px #ffcc0055;
}

.btn-itinerary {
  border: 2px solid #66ff99;
  color: #66ff99;
  box-shadow: 0 0 6px #66ff9955;
}

/* Glow on hover */
.btn-attractions:hover {
  background: #ff6f61;
  color: black;
  box-shadow: 0 0 12px #ff6f61, 0 0 24px #ff6f61aa;
}

.btn-restaurants:hover {
  background: #ffcc00;
  color: black;
  box-shadow: 0 0 12px #ffcc00, 0 0 24px #ffcc00aa;
}

.btn-itinerary:hover {
  background: #66ff99;
  color: black;
  box-shadow: 0 0 12px #66ff99, 0 0 24px #66ff99aa;
}



.current-plan-alert {
  background: rgba(255, 255, 255, 0.05) !important;
  border: 1px solid rgba(255, 255, 255, 0.15) !important;
  color: #f1f1f1 !important;
  backdrop-filter: blur(14px);
  border-radius: 18px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
}

.current-plan-alert .btn-outline-success {
  border-color: #66ff99;
  color: #66ff99;
  transition: all 0.3s ease;
}

.current-plan-alert .btn-outline-success:hover {
  background-color: #66ff99 !important;
  color: black !important;
  box-shadow: 0 0 12px #66ff99, 0 0 24px #66ff99aa;
}

.current-plan-alert .btn-outline-danger {
  border-color: #ff6f61;
  color: #ff6f61;
  transition: all 0.3s ease;
}

.current-plan-alert .btn-outline-danger:hover {
  background-color: #ff6f61 !important;
  color: black !important;
  box-shadow: 0 0 12px #ff6f61, 0 0 24px #ff6f61aa;
}

/* Icon animations */
.feature-icon {
  font-size: 3rem;
  color: #00e0ff;
  filter: drop-shadow(0 0 10px #00e0ff88);
  transition: transform 0.3s ease, filter 0.3s ease;
}


.feature-card:hover .feature-icon {
  filter: drop-shadow(0 0 14px #00e0ffcc);
  transform: scale(1.1);
}


.feature-icon {
  animation: iconPulse 3s ease-in-out infinite;
}


.circle-bg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;
}

.circle {
  position: absolute;
  border-radius: 50%;
  background: rgba(0, 132, 255, 0.1);
  backdrop-filter: blur(6px);
  box-shadow: 0 0 40px rgba(0, 132, 255, 0.3);
  animation: floaty 10s infinite ease-in-out alternate;
  transform-origin: center;
  color: #4db8ff !important;
  text-shadow: 0 0 10px #4db8ff88;
}

.circle1 {
  width: 80px;
  height: 80px;
  top: 10%;
  left: 15%;
  animation-delay: 0s;
}

.circle2 {
  width: 120px;
  height: 120px;
  top: 18%; /* moved up from 30% */
  left: 65%;
  animation-delay: 1s;
}

.circle3 {
  width: 60px;
  height: 60px;
  top: 55%;
  left: 40%;
  animation-delay: 2s;
}

.circle4 {
  width: 100px;
  height: 100px;
  top: 70%;
  left: 80%;
  animation-delay: 3s;
}

.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.custom-modal {
  background: rgba(30, 39, 64, 0.95);
  border: 1px solid rgba(77, 184, 255, 0.3);
  border-radius: 16px;
  padding: 25px 30px;
  width: 90%;
  max-width: 450px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(77, 184, 255, 0.2);
  text-align: center;
  transform: translateY(0);
  animation: modal-in 0.3s ease-out;
}

@keyframes modal-in {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-icon {
  font-size: 3rem;
  color: #ff6f61;
  margin-bottom: 15px;
}

.modal-title {
  font-size: 1.4rem;
  font-weight: 700;
  color: white;
  margin-bottom: 15px;
}

.modal-message {
  font-size: 1.1rem;
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 25px;
}

.modal-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
}

.modal-btn {
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 600;
  transition: all 0.2s ease;
  border: none;
  cursor: pointer;
}

.btn-cancel {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-cancel:hover {
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
}

.btn-danger {
  background: linear-gradient(135deg, #ff6f61, #ff427f);
  color: white;
  box-shadow: 0 4px 15px rgba(255, 111, 97, 0.4);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 111, 97, 0.6);
}

@keyframes floaty {
  0% {
    transform: translateY(0px) translateX(0px) scale(1) rotate(0deg);
    opacity: 0.4;
  }
  50% {
    transform: translateY(-40px) translateX(20px) scale(1.1) rotate(15deg);
    opacity: 0.6;
  }
  100% {
    transform: translateY(30px) translateX(-20px) scale(1) rotate(-10deg);
    opacity: 0.4;
  }
}


@keyframes iconPulse {
  0%, 100% { transform: scale(1); }
  50%      { transform: scale(1.1); }
}

@keyframes bounceIcon {
  0%   { transform: translateY(0); }
  30%  { transform: translateY(-8px); }
  60%  { transform: translateY(4px); }
  100% { transform: translateY(0); }
}

/* Animations */
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

[data-scroll] {
  opacity: 0;
  transform: translateY(40px);
  transition: opacity 0.8s ease-out, transform 0.8s ease-out;
}

[data-scroll].scrolled {
  opacity: 1;
  transform: translateY(0);
}

/* Dark themed input and date fields */
.form-control {
  background-color: rgba(255, 255, 255, 0.05);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.15);
}

.form-control::placeholder {
  color: rgba(255, 255, 255, 0.6);
}

.form-control:focus {
  background-color: rgba(255, 255, 255, 0.1);
  border-color: #4db8ff;
  box-shadow: 0 0 0 0.2rem rgba(77, 184, 255, 0.25);
  color: white;
}

.trip-duration-badge {
  background-color: rgba(0, 114, 255, 0.2);
  color: #4db8ff;
  border: 1px solid rgba(77, 184, 255, 0.3);
  border-radius: 6px;
  padding: 5px 10px;
  font-size: 0.9rem;
  display: inline-block;
  margin-top: 10px;
  backdrop-filter: blur(5px);
  text-align: center;
  transition: all 0.3s ease;
}

.btn-outline-danger {
  background: linear-gradient(135deg, #ff6f61, #ff427f);
  color: white;
  border: none;
  font-weight: 600;
  box-shadow: 0 6px 20px rgba(255, 111, 97, 0.5);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.btn-outline-danger:hover {
  transform: scale(1.06);
  box-shadow: 0 8px 28px rgba(255, 111, 97, 0.7);
}

</style>

</head>
<body>
  <div class="page-wrapper d-flex flex-column min-vh-100">
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <img src="/assets/logo.png" alt="Logo" class="logo-img" />
        <span class="brand-text" id="brand-text"></span>
      </a>
      
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link active" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/attractions">Attractions</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/restaurants">Restaurants</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/flights">Flights</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/hotels">Hotels</a>
          </li>
          <!-- Auth buttons - these will be replaced by user info when logged in -->
          <li class="nav-item ms-3">
            <a class="btn btn-outline-light" href="https://us-east-1zjt65d7ot.auth.us-east-1.amazoncognito.com/login?client_id=3anj5rhtknc7i97jq3jgknai71&response_type=code&scope=email+openid+phone&redirect_uri=http%3A%2F%2Flocalhost%3A3000">Login</a>
          </li>
          <li class="nav-item ms-2">
            <a class="btn btn-outline-light" href="https://us-east-1zjt65d7ot.auth.us-east-1.amazoncognito.com/signup?client_id=3anj5rhtknc7i97jq3jgknai71&redirect_uri=http%3A%2F%2Flocalhost%3A3000&response_type=code&scope=email+openid+phone">Sign Up</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Hero Section -->
    <section class="hero-section text-center">
      <div class="container">
        <div class="circle-bg">
          <div class="circle circle1"></div>
          <div class="circle circle2"></div>
          <div class="circle circle3"></div>
          <div class="circle circle4"></div>
        </div>
        <h1 class="display-4"><span id="typewriter-text"></span></h1>

        <p class="lead">Discover amazing places to visit and restaurants to try at your next destination.</p>
      </div>
    </section>

    <!-- Planning Form Section -->
    <section class="container mb-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="planning-card">
            <h2 class="text-center mb-4" data-scroll>Create Your Trip Plan</h2>
            <form id="plan-form">
              <!-- Country -->
              <div class="mb-3">
                <label for="country" class="form-label">Country</label>
                <input type="text" class="form-control" id="country" placeholder="e.g. Japan" required>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="start-date" class="form-label">Start Date</label>
                  <input type="date" class="form-control" id="start-date" required>
                </div>
                <div class="col-md-6">
                  <label for="end-date" class="form-label">End Date</label>
                  <input type="date" class="form-control" id="end-date" required>
                </div>
                <div class="col-12">
                  <div id="trip-duration" class="trip-duration-badge" style="display: none;"></div>
                </div>
              </div>

              <!-- Hidden warning -->
              <p id="date-required-warning" class="text-danger d-none text-center mb-3">Choose your dates before planning cities.</p>

              <!-- Wrap city logic -->
              <div id="city-details-wrapper" class="d-none">
                <div class="mb-3 form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="city-selection-toggle">
                  <label class="form-check-label" for="city-selection-toggle">Multiple Cities</label>
                </div>

                <!-- Single City Input -->
                <div class="mb-3" id="single-city-wrapper">
                  <label for="destination" class="form-label">City</label>
                  <input type="text" class="form-control" id="destination" placeholder="City name..." required />
                </div>

                <!-- Multi-City Input Group -->
                <div class="mb-3 d-none" id="multi-city-wrapper">
                  <label class="form-label">Cities and Days</label>
                  <div id="days-left-container" class="mb-2 text-center">
                    <span id="days-left" class="badge bg-secondary"></span>
                  </div>
                  <div id="cities-container">
                    <div class="row mb-2 city-entry">
                      <div class="col-md-6">
                        <input type="text" class="form-control city-name" placeholder="City name" required />
                      </div>
                      <div class="col-md-4">
                        <input type="number" class="form-control city-days" placeholder="Days" min="1" required />
                      </div>
                      <div class="col-md-2">
                        <button type="button" class="btn btn-danger remove-city w-100">−</button>
                      </div>
                    </div>
                  </div>
                  <button type="button" id="add-city-btn" class="btn btn-outline-light mt-2">+ Add City</button>
                  <p id="date-warning" class="text-danger mt-2 d-none">Choose your dates before adding cities.</p>
                </div>

                <div class="text-center d-flex justify-content-center align-items-center gap-3">
                  <button type="submit" class="btn btn-primary btn-lg px-4">Start Planning</button>
                  <button type="button" id="clear-plan-btn" class="btn btn-outline-danger btn-lg px-4" style="display: none;">Clear Plan</button>
                </div>
              </div>

            </form>
          </div>
          
          <!-- Current Plan Alert (hidden by default) -->
          <div id="current-plan-alert" class="alert alert-success current-plan-alert" role="alert" style="display: none;">
            <h4 class="alert-heading">Your current trip plan:</h4>
            <p id="current-plan-details">
              You're planning a trip to <span id="plan-destination"></span> from <span id="plan-dates"></span>.
            </p>
            <hr>
            <div class="d-flex justify-content-between">
              <a href="/itinerary" class="btn btn-outline-success">View Itinerary</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Features Section -->
    <section class="container mb-5">
      <h2 class="text-center mb-4">Plan Your Trip With Ease</h2>
      <div class="row g-4 align-items-stretch">
        
        <!-- Card 1 -->
        <div class="col-md-4 d-flex">
          <div class="card feature-card text-center p-4 w-100 d-flex flex-column justify-content-between">
            <div class="feature-icon mb-3">🏛️</div>
            <div class="card-body d-flex flex-column">
              <h3 class="card-title">Find Attractions</h3>
              <p class="card-text flex-grow-1">Discover the best tourist spots, landmarks, museums, and more at your destination.</p>
              <a href="/attractions" class="btn btn-attractions mt-3">Explore Attractions</a>
            </div>
          </div>
        </div>

        <!-- Card 2 -->
        <div class="col-md-4 d-flex">
          <div class="card feature-card text-center p-4 w-100 d-flex flex-column justify-content-between">
            <div class="feature-icon mb-3">🍽️</div>
            <div class="card-body d-flex flex-column">
              <h3 class="card-title">Discover Restaurants</h3>
              <p class="card-text flex-grow-1">Find the best local cuisine, popular eateries, and hidden gems to satisfy your taste buds.</p>
              <a href="/restaurants" class="btn btn-restaurants mt-3">Find Restaurants</a>
            </div>
          </div>
        </div>

        <!-- Card 3 -->
        <div class="col-md-4 d-flex">
          <div class="card feature-card text-center p-4 w-100 d-flex flex-column justify-content-between">
            <div class="feature-icon mb-3">📝</div>
            <div class="card-body d-flex flex-column">
              <h3 class="card-title">Create Itinerary</h3>
              <p class="card-text flex-grow-1">Organize your trip by saving attractions and restaurants to your personalized itinerary.</p>
              <a href="/itinerary" class="btn btn-itinerary mt-3">View Itinerary</a>
            </div>
          </div>
        </div>

      </div>
    </section>




  
  <!-- Footer -->
  <footer class="text-center py-4">
    <div class="container">
      <p class="mb-0">© 2025 One Click Planner. All rights reserved.</p>
    </div>
  </footer>

    </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {

  const planForm = document.getElementById('plan-form');
  const currentPlanAlert = document.getElementById('current-plan-alert');
  const planDestination = document.getElementById('plan-destination');
  const planDates = document.getElementById('plan-dates');
  const clearPlanBtn = document.getElementById('clear-plan-btn');
  const startDateInput = document.getElementById('start-date');
  const endDateInput = document.getElementById('end-date');
  const citySelect = document.getElementById('city-selection');
  const singleCityWrapper = document.getElementById('single-city-wrapper');
  const multiCityWrapper = document.getElementById('multi-city-wrapper');
  const citiesContainer = document.getElementById('cities-container');
  const addCityBtn = document.getElementById('add-city-btn');
  const cityToggle = document.getElementById('city-selection-toggle');


  // This function properly toggles form validation based on the city selection mode
function toggleCityInputValidation() {
  const isMulti = document.getElementById('city-selection-toggle').checked;
  const singleCityWrapper = document.getElementById('single-city-wrapper');
  const multiCityWrapper = document.getElementById('multi-city-wrapper');
  const daysLeftContainer = document.getElementById('days-left-container');
  
  // Update UI visibility
  singleCityWrapper.classList.toggle('d-none', isMulti);
  multiCityWrapper.classList.toggle('d-none', !isMulti);
  
  // Always show days left container in multi-city mode
  if (isMulti) {
    daysLeftContainer.style.display = 'block';
    // Update days left when switching to multi-city mode
    updateDaysLeft();
  } else {
    daysLeftContainer.style.display = 'none';
  }
  // Single city input
  const destinationInput = document.getElementById('destination');
  
  // Handle single city mode
  if (!isMulti) {
    // Enable single city input and make it required
    destinationInput.disabled = false;
    destinationInput.required = true;
    
    // Disable all multi-city inputs
    const multiCityInputs = multiCityWrapper.querySelectorAll('input');
    multiCityInputs.forEach(input => {
      input.disabled = true;
      input.required = false;
    });
  } 
  // Handle multi-city mode
  else {
    // Disable single city input
    destinationInput.disabled = true;
    destinationInput.required = false;
    
    // Enable all multi-city inputs
    const multiCityInputs = multiCityWrapper.querySelectorAll('input');
    multiCityInputs.forEach(input => {
      input.disabled = false;
      input.required = true;
    });
    
    
    // If switching to multi-city mode and there are no entries, add one
// If switching to multi-city mode and there are no entries, add one
const citiesContainer = document.getElementById('cities-container');
if (citiesContainer.children.length === 0) {
  const entry = document.createElement('div');
  entry.className = 'row mb-2 city-entry';
  entry.innerHTML = `
    <div class="col-md-6">
      <input type="text" class="form-control city-name" placeholder="City name" required />
    </div>
    <div class="col-md-4">
      <input type="number" class="form-control city-days" placeholder="Days" min="1" required />
    </div>
    <div class="col-md-2">
      <button type="button" class="btn btn-danger remove-city w-100">−</button>
    </div>
  `;
  citiesContainer.appendChild(entry);
  attachCityDaysListeners();
  updateAddCityBtnState();
}
  }
}


// Add a new city entry
function addCityEntry() {
  const citiesContainer = document.getElementById('cities-container');
  const entry = document.createElement('div');
  entry.className = 'row mb-2 city-entry';
  entry.innerHTML = `
    <div class="col-md-6">
      <input type="text" class="form-control city-name" placeholder="City name" required />
    </div>
    <div class="col-md-4">
      <input type="number" class="form-control city-days" placeholder="Days" min="1" required />
    </div>
    <div class="col-md-2">
      <button type="button" class="btn btn-danger remove-city w-100">−</button>
    </div>
  `;
  citiesContainer.appendChild(entry);
  attachCityDaysListeners();
  updateAddCityBtnState();
}

// Initial form validation setup based on selection mode
const isMulti = cityToggle.checked;
const destinationInput = document.getElementById('destination');
const multiCityInputs = document.getElementById('multi-city-wrapper').querySelectorAll('input');

if (isMulti) {
  // Multi-city mode: disable single city input
  destinationInput.disabled = true;
  destinationInput.required = false;
  
  // Enable all multi-city inputs
  multiCityInputs.forEach(input => {
    input.disabled = false;
    input.required = true;
  });
} else {
  // Single city mode: enable single city input
  destinationInput.disabled = false;
  destinationInput.required = true;
  
  // Disable all multi-city inputs
  multiCityInputs.forEach(input => {
    input.disabled = true;
    input.required = false;
  });
}

  function displayCurrentPlan(plan) {
    if (!plan || !plan.destination) return;
    
    // Format destination with country
    let destinationText = plan.destination;
    if (plan.country) {
      destinationText = `${plan.destination} in ${plan.country}`;
    }
    
    // Update DOM elements
    document.getElementById('plan-destination').textContent = destinationText;
    document.getElementById('plan-dates').textContent = formatDateRange(plan.startDate, plan.endDate);
    document.getElementById('current-plan-alert').style.display = 'block';
    
    // Pre-fill form if needed
    if (document.getElementById('country')) {
      document.getElementById('country').value = plan.country || '';
    }
    
    // Check if this is a multi-city plan
    if (plan.cities && plan.cities.length > 1) {
      // 1. Set the toggle to checked
      const cityToggle = document.getElementById('city-selection-toggle');
      
      cityToggle.checked = true;
      
      // 2. Trigger the UI update for multi-city mode
      document.getElementById('single-city-wrapper').classList.add('d-none');
      document.getElementById('multi-city-wrapper').classList.remove('d-none');
      
      // 3. Populate multi-city UI with the cities from the plan
      setupMultiCityUI(plan.cities);
    } else {
      // Single city mode
      // If destination is a single city (no commas, no city count indicators)
      if (document.getElementById('destination') && (!plan.destination.includes(',') || plan.cities?.length === 1)) {
        // Extract city name if it has a format like "Tokyo (2d)"
        let cityName = plan.destination;
        if (cityName.includes('(')) {
          cityName = cityName.split('(')[0].trim();
        }
        document.getElementById('destination').value = cityName;
      }
    }
  }

  // Add/improve the setupMultiCityUI function if it doesn't exist or needs enhancement
  function setupMultiCityUI(cities) {
    // 1. Show multi-city UI
    document.getElementById('single-city-wrapper').classList.add('d-none');
    document.getElementById('multi-city-wrapper').classList.remove('d-none');
    
    // 2. Clear existing entries and add cities
    const citiesContainer = document.getElementById('cities-container');
    citiesContainer.innerHTML = '';
    
    // 3. Add each city with its day allocation
    cities.forEach(city => {
      const entry = document.createElement('div');
      entry.className = 'row mb-2 city-entry';
      entry.innerHTML = `
        <div class="col-md-6">
          <input type="text" class="form-control city-name" value="${city.name}" placeholder="City name" required />
        </div>
        <div class="col-md-4">
          <input type="number" class="form-control city-days" value="${city.days}" placeholder="Days" min="1" required />
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-danger remove-city w-100">−</button>
        </div>
      `;
      citiesContainer.appendChild(entry);
    });
    
    // 4. Setup listeners for the new entries
    attachCityDaysListeners();
    updateAddCityBtnState();
  }


  function attachCityDaysListeners() {
  const dayInputs = document.querySelectorAll('.city-days');
  console.log('Day inputs found:', dayInputs.length);
  
  dayInputs.forEach(input => {
    console.log('Attaching listeners to input:', input);
    
    input.removeEventListener('input', updateAddCityBtnState);
    input.removeEventListener('input', validateCityDaysInput);
    input.removeEventListener('input', updateDaysLeft);

    input.addEventListener('input', updateAddCityBtnState);
    input.addEventListener('input', validateCityDaysInput);
    input.addEventListener('input', updateDaysLeft);
  });
}


  function validateCityDaysInput(e) {
    const totalTripDays = calculateTripDays(startDateInput.value, endDateInput.value);
    const currentInput = e.target;
    const allInputs = document.querySelectorAll('.city-days');

    let usedSoFar = 0;
    allInputs.forEach(input => {
      if (input !== currentInput) {
        const val = parseInt(input.value);
        if (!isNaN(val)) usedSoFar += val;
      }
    });

    let value = parseInt(currentInput.value);
    if (isNaN(value) || value < 1) value = 1;

    // Cap the current input to not exceed the total trip days
    const maxAllowed = totalTripDays - usedSoFar;
    if (value > maxAllowed) {
      currentInput.value = maxAllowed > 0 ? maxAllowed : 1;
    }
  }

  function updateTripDuration() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    // Get the container where we'll show the duration (we'll create this in HTML)
    const durationElement = document.getElementById('trip-duration');
    
    if (startDate && endDate) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      
      // Calculate the difference in days
      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // Include both start and end days
      
      // Display the duration
      durationElement.innerHTML = `<i class="bi bi-calendar-check"></i> Trip Duration: <strong>${diffDays} day${diffDays !== 1 ? 's' : ''}</strong>`;
      durationElement.style.display = 'block';
    } else {
      // Hide the element if either date is not set
      durationElement.style.display = 'none';
    }
  }



  function toggleCitySectionVisibility() {
  const start = document.getElementById('start-date').value;
  const end = document.getElementById('end-date').value;
  const wrapper = document.getElementById('city-details-wrapper');
  const warning = document.getElementById('date-required-warning');

  if (start && end) {
    wrapper.classList.remove('d-none');
    warning.classList.add('d-none');
  } else {
    wrapper.classList.add('d-none');
    warning.classList.remove('d-none');
  }
  } 

  document.getElementById('start-date').addEventListener('change', toggleCitySectionVisibility);
  document.getElementById('end-date').addEventListener('change', toggleCitySectionVisibility);
  attachCityDaysListeners(); // for the initial city-days input on page load

  document.getElementById('start-date').addEventListener('change', updateTripDuration);
  document.getElementById('end-date').addEventListener('change', updateTripDuration);

  document.getElementById('start-date').addEventListener('change', function() {
  toggleCitySectionVisibility();
  updateTripDuration();
  updateDaysLeft();
});

document.getElementById('end-date').addEventListener('change', function() {
  toggleCitySectionVisibility();
  updateTripDuration();
  updateDaysLeft();
});

  document.addEventListener('DOMContentLoaded', function() {

      // Initial setup for city toggle
  const cityToggle = document.getElementById('city-selection-toggle');
  const daysLeftContainer = document.getElementById('days-left-container');
  
  if (cityToggle.checked) {
    daysLeftContainer.style.display = 'block';
    updateDaysLeft();
  } else {
    daysLeftContainer.style.display = 'none';
  }
  
    // Initial call to set up the display
    updateTripDuration();
  });

  cityToggle.addEventListener('change', function() {
    const isMulti = this.checked;

    toggleCityInputValidation();
  
  // If switching back to single city, try to use the first city name
  if (!this.checked) {
    const cityInputs = document.querySelectorAll('.city-name');
    if (cityInputs.length > 0 && cityInputs[0].value) {
      document.getElementById('destination').value = cityInputs[0].value;
    }
  }

    console.log("Toggle changed to:", isMulti ? "multi-city" : "single-city");
    
    // Update UI visibility
    singleCityWrapper.classList.toggle('d-none', isMulti);
    multiCityWrapper.classList.toggle('d-none', !isMulti);
    
    // Update validation requirements
    const destinationInput = document.getElementById('destination');
    if (isMulti) {
      destinationInput.removeAttribute('required');
      
      // If switching to multi-city mode and there are no entries, add one
      const citiesContainer = document.getElementById('cities-container');
      if (citiesContainer.children.length === 0) {
        const entry = document.createElement('div');
        entry.className = 'row mb-2 city-entry';
        entry.innerHTML = `
          <div class="col-md-6">
            <input type="text" class="form-control city-name" placeholder="City name" required />
          </div>
          <div class="col-md-4">
            <input type="number" class="form-control city-days" placeholder="Days" min="1" required />
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger remove-city w-100">−</button>
          </div>
        `;
        citiesContainer.appendChild(entry);
        attachCityDaysListeners();
        updateAddCityBtnState();
      }
    } else {
      destinationInput.setAttribute('required', 'required');
      
      // If switching back to single city, try to use the first city name
      const cityInputs = document.querySelectorAll('.city-name');
      if (cityInputs.length > 0 && cityInputs[0].value) {
        destinationInput.value = cityInputs[0].value;
      }
    }
  });


  // Add new city entry
  addCityBtn.addEventListener('click', () => {
    const entry = document.createElement('div');
    entry.className = 'row mb-2 city-entry';
    entry.innerHTML = `
      <div class="col-md-6">
        <input type="text" class="form-control city-name" placeholder="City name" required />
      </div>
      <div class="col-md-4">
        <input type="number" class="form-control city-days" placeholder="Days" min="1" required />
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-danger remove-city w-100">−</button>
      </div>
    `;
    citiesContainer.appendChild(entry);
    attachCityDaysListeners(); // <== CALL HERE
    updateAddCityBtnState();
  });


  // Remove city entry
  citiesContainer.addEventListener('click', e => {
  if (e.target.classList.contains('remove-city')) {
    const row = e.target.closest('.city-entry');
    const daysToRemove = parseInt(row.querySelector('.city-days').value); // Get days for the city being removed
    row.remove();
    updateAvailableDays(daysToRemove); // Update available days after deletion
  }
  });

  function updateAvailableDays(daysToRemove = 0) {
  const totalDays = calculateTripDays(startDateInput.value, endDateInput.value);  // Get total trip days
  const usedDays = getUsedCityDays() - daysToRemove;  // Subtract days from the removed city

  // Enable or disable the "Add City" button based on available days
  const addCityBtn = document.getElementById('add-city-btn');
  addCityBtn.disabled = usedDays >= totalDays;
}

function getUsedCityDays() {
  const dayInputs = document.querySelectorAll('.city-days');
  let usedDays = 0;
  dayInputs.forEach(input => {
    const val = parseInt(input.value);
    if (!isNaN(val)) usedDays += val;
  });
  return usedDays;
}

  function calculateTripDays(start, end) {
  const s = new Date(start);
  const e = new Date(end);
  const diff = Math.floor((e - s) / (1000 * 60 * 60 * 24)) + 1;
  return diff > 0 ? diff : 0;
}

function updateDaysLeft() {
  const start = document.getElementById('start-date').value;
  const end = document.getElementById('end-date').value;
  const totalDays = calculateTripDays(start, end);
  const usedDays = getUsedCityDays();
  
  const daysLeftElement = document.getElementById('days-left');
  if (daysLeftElement) {
    const daysLeft = totalDays - usedDays;
    daysLeftElement.textContent = `Days Left: ${daysLeft}`;
    daysLeftElement.style.color = daysLeft === 0 ? '#66ff99' : (daysLeft < 0 ? '#ff6f61' : 'inherit');
  }
  
  return daysLeft;
}

function getUsedCityDays() {
  const dayInputs = document.querySelectorAll('.city-days');
  let usedDays = 0;
  dayInputs.forEach(input => {
    const val = parseInt(input.value);
    if (!isNaN(val)) usedDays += val;
  });
  return usedDays;
}

function updateAddCityBtnState() {
  const start = document.getElementById('start-date').value;
  const end = document.getElementById('end-date').value;
  const warning = document.getElementById('date-warning');
  const addBtn = document.getElementById('add-city-btn');

  if (!start || !end) {
    warning.classList.remove('d-none');
    addBtn.disabled = true;
    return;
  }

  warning.classList.add('d-none');

  const totalDays = calculateTripDays(start, end);
  const usedDays = getUsedCityDays();

  addBtn.disabled = usedDays >= totalDays;
}

function validateCityDaysExactly() {
  const start = document.getElementById('start-date').value;
  const end = document.getElementById('end-date').value;
  const totalDays = calculateTripDays(start, end);
  const usedDays = getUsedCityDays();

  if (!start || !end) {
    alert("Please choose a start and end date.");
    return false;
  }

  if (usedDays !== totalDays) {
    alert(`You've assigned ${usedDays} days, but your trip is ${totalDays} days. Adjust to match.`);
    return false;
  }

  return true;
}


  // Set min date for start date (today)
  const today = new Date().toISOString().split('T')[0];
  startDateInput.setAttribute('min', today);
  
  // Disable end date until start date is selected
  endDateInput.setAttribute('disabled', true);
  
  // When start date changes, update end date constraints
  startDateInput.addEventListener('change', function() {
    if (startDateInput.value) {
      // Enable end date input
      endDateInput.removeAttribute('disabled');
      
      // Set minimum date for end date input (should be the start date)
      endDateInput.setAttribute('min', startDateInput.value);
      
      // If end date is before start date, reset it
      if (endDateInput.value && endDateInput.value < startDateInput.value) {
        endDateInput.value = '';
      }
    } else {
      // If start date is cleared, disable end date
      endDateInput.setAttribute('disabled', true);
      endDateInput.value = '';
    }
  });

  // Format dates for display
  function formatDateRange(startDate, endDate) {
    if (!startDate && !endDate) return 'dates not specified';
    if (!startDate) return `until ${new Date(endDate).toLocaleDateString()}`;
    if (!endDate) return `starting ${new Date(startDate).toLocaleDateString()}`;
    
    return `${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}`;
  }

  function setupClearPlanButton() {
  const clearPlanBtn = document.getElementById('clear-plan-btn');
  const currentPlanAlert = document.getElementById('current-plan-alert');
  const cityDetailsWrapper = document.getElementById('city-details-wrapper');

  // Function to show/hide clear plan button based on current plan
  function toggleClearPlanButton() {
    if (currentPlanAlert.style.display !== 'none') {
      clearPlanBtn.style.display = 'block';
    } else {
      clearPlanBtn.style.display = 'none';
    }
  }

  // Initial check
  toggleClearPlanButton();

  // Create a MutationObserver to watch for changes in current plan alert
  const observer = new MutationObserver(toggleClearPlanButton);
  observer.observe(currentPlanAlert, { 
    attributes: true, 
    attributeFilter: ['style'] 
  });

  // Modify clear plan button event listener
  clearPlanBtn.addEventListener('click', function() {
    // Use our custom confirm dialog
    showCustomConfirmDialog('Are you sure you want to clear your current trip plan?', function(confirmed) {
      if (confirmed) {
        // Call the DELETE endpoint
        fetch('/api/plan', {
          method: 'DELETE',
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Show success message
              showCustomMessage('Plan Cleared', 'Your trip plan has been successfully cleared.');
              
              // Reset form and UI
              const planForm = document.getElementById('plan-form');
              planForm.reset();
              
              const endDateInput = document.getElementById('end-date');
              endDateInput.setAttribute('disabled', true);
              
              currentPlanAlert.style.display = 'none';
              
              // Reset any city entries in multi-city mode
              const citiesContainer = document.getElementById('cities-container');
              if (citiesContainer) {
                citiesContainer.innerHTML = '';
              }
              
              // Hide city details wrapper
              if (cityDetailsWrapper) {
                cityDetailsWrapper.classList.add('d-none');
              }
              
              // Show date required warning
              const dateRequiredWarning = document.getElementById('date-required-warning');
              if (dateRequiredWarning) {
                dateRequiredWarning.classList.remove('d-none');
              }
              
              // Reset city toggle
              const cityToggle = document.getElementById('city-selection-toggle');
              if (cityToggle) {
                cityToggle.checked = false;
                
                // Reset single/multi city visibility
                const singleCityWrapper = document.getElementById('single-city-wrapper');
                const multiCityWrapper = document.getElementById('multi-city-wrapper');
                if (singleCityWrapper && multiCityWrapper) {
                  singleCityWrapper.classList.remove('d-none');
                  multiCityWrapper.classList.add('d-none');
                }
              }
              
              // Hide clear plan button
              clearPlanBtn.style.display = 'none';
            } else {
              console.error('Failed to clear plan:', data);
              alert('Failed to clear your plan. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error clearing plan:', error);
            alert('Error clearing your plan. Please try again.');
          });
      }
    });
  });
}


  function showWeatherForDateRange(forecast, startDate, endDate) {
  const weatherSection = document.createElement('section');
  weatherSection.className = 'container mb-5';
  weatherSection.innerHTML = `
    <h2 class="text-center mb-4">Rain Forecast During Your Trip</h2>
    <ul id="weather-results" class="list-group"></ul>
  `;
  document.querySelector('.main-content').appendChild(weatherSection);

  const resultList = document.getElementById('weather-results');
  const start = new Date(startDate);
  const end = new Date(endDate);

  const entries = forecast.filter(entry => {
    const entryDate = new Date(entry.datetime);
    return entryDate >= start && entryDate <= end;
  });

  if (entries.length === 0) {
    resultList.innerHTML = '<li class="list-group-item">No rain forecasted during your trip dates 🎉</li>';
    return;
  }

  entries.forEach(entry => {
    const item = document.createElement('li');
    item.className = 'list-group-item';
    item.innerHTML = `
      <strong>${new Date(entry.datetime).toLocaleString()}</strong><br>
      ☔ <strong>Rain:</strong> ${entry.rainVolume} mm<br>
      🌡️ <strong>Temp:</strong> ${entry.temp}°C<br>
      🌤️ <strong>Forecast:</strong> ${entry.weather}
    `;
    resultList.appendChild(item);
  });
}

function showCustomConfirmDialog(message, callback) {
  // Create modal backdrop
  const modalBackdrop = document.createElement('div');
  modalBackdrop.className = 'modal-backdrop';
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.className = 'custom-modal';
  
  // Add modal content
  modalContent.innerHTML = `
    <div class="modal-icon">
      <i class="bi bi-exclamation-circle"></i>
    </div>
    <h3 class="modal-title">Confirm Action</h3>
    <p class="modal-message">${message}</p>
    <div class="modal-buttons">
      <button class="modal-btn btn-cancel" id="confirmCancel">Cancel</button>
      <button class="modal-btn btn-danger" id="confirmOk">Clear Plan</button>
    </div>
  `;
  
  // Add modal to DOM
  modalBackdrop.appendChild(modalContent);
  document.body.appendChild(modalBackdrop);
  
  // Add event listeners to buttons
  document.getElementById('confirmCancel').addEventListener('click', function() {
    document.body.removeChild(modalBackdrop);
    if (callback) callback(false);
  });
  
  document.getElementById('confirmOk').addEventListener('click', function() {
    document.body.removeChild(modalBackdrop);
    if (callback) callback(true);
  });
  
  // Prevent clicks on the backdrop from closing the modal
  modalBackdrop.addEventListener('click', function(e) {
    if (e.target === modalBackdrop) {
      document.getElementById('confirmCancel').click();
    }
  });
  
  // Add keyboard support (Esc to cancel, Enter to confirm)
  const keyHandler = function(e) {
    if (e.key === 'Escape') {
      document.getElementById('confirmCancel').click();
      document.removeEventListener('keydown', keyHandler);
    } else if (e.key === 'Enter') {
      document.getElementById('confirmOk').click();
      document.removeEventListener('keydown', keyHandler);
    }
  };
  document.addEventListener('keydown', keyHandler);
}


// Check if there's an existing plan
fetch('/api/plan')
  .then(response => response.json())
  .then(data => {
    if (data.plan) {
      
      // Fill in basic fields
      if (data.plan.country) {
        document.getElementById('country').value = data.plan.country;
      }
      
      if (data.plan.startDate) {
        startDateInput.value = data.plan.startDate;
        endDateInput.removeAttribute('disabled');
        endDateInput.setAttribute('min', startDateInput.value);
      }
      
      if (data.plan.endDate) {
        endDateInput.value = data.plan.endDate;
      }
      
      // Make city section visible
      if (data.plan.startDate && data.plan.endDate) {
        document.getElementById('city-details-wrapper').classList.remove('d-none');
        document.getElementById('date-required-warning').classList.add('d-none');
      }
      
      // Enhanced check for multiple cities
      let hasMultipleCities = false;
      
      // First check for cities array
      if (Array.isArray(data.plan.cities) && data.plan.cities.length > 1) {
        console.log("Multiple cities detected from cities array:", data.plan.cities);
        hasMultipleCities = true;
      } 
      // Fallback: Check destination string for comma-separated format
      else if (data.plan.destination && data.plan.destination.includes(',')) {
        console.log("Multiple cities detected from destination string:", data.plan.destination);
        
        // Parse cities from the destination string as a fallback
        const cityParts = data.plan.destination.split(',').map(part => part.trim());
        const parsedCities = cityParts.map(part => {
          const match = part.match(/(.+?)\s*\((\d+)d\)/);
          if (match) {
            return { name: match[1].trim(), days: parseInt(match[2]) };
          }
          return { name: part, days: 0 };
        });
        
        console.log("Parsed cities from destination:", parsedCities);
        // Only replace cities if we've actually found multiple
        if (parsedCities.length > 1) {
          data.plan.cities = parsedCities;
          hasMultipleCities = true;
        }
      }
      
      if (hasMultipleCities) {
        // First force the toggle to be checked
        const cityToggle = document.getElementById('city-selection-toggle');
        cityToggle.checked = true;
        
        // Then manually show/hide the appropriate sections
        document.getElementById('single-city-wrapper').classList.add('d-none');
        document.getElementById('multi-city-wrapper').classList.remove('d-none');
        
        // Setup the multi-city UI
        setupMultiCityUI(data.plan.cities);
      } else if (data.plan.destination) {
        // Single city case
        let cityName = data.plan.destination;
        if (cityName.includes('(')) {
          cityName = cityName.split('(')[0].trim();
        }
        document.getElementById('destination').value = cityName;
      }
      
      // Display current plan alert
      displayCurrentPlan(data.plan);
    }
  })
  .catch(error => console.error('Error loading plan:', error));

// Handle form submission
planForm.addEventListener('submit', function (e) {
  e.preventDefault();

  const startDate = startDateInput.value;
  const endDate = endDateInput.value;
  const country = document.getElementById('country').value.trim();

  if (!startDate || !endDate) {
    alert('Please select both a start and end date.');
    return;
  }

  if (new Date(endDate) < new Date(startDate)) {
    alert('End date cannot be before start date.');
    return;
  }

  // Check if the current button text indicates an update
  const isUpdating = document.querySelector('#plan-form button[type="submit"]').textContent === 'Update Plan';

  if (cityToggle.checked && !validateCityDaysExactly()) {
    // If it was in "Update Plan" mode, keep it in update mode
    if (isUpdating) {
      const submitButton = document.querySelector('#plan-form button[type="submit"]');
      submitButton.textContent = 'Update Plan';
      submitButton.classList.remove('btn-primary');
      submitButton.classList.add('btn-success');
    }
    return;
  }

  let destination = '';
  let cities = [];

  if (!cityToggle.checked) {
    const name = document.getElementById('destination').value.trim();
    destination = name;
    const totalDays = calculateTripDays(startDate, endDate);
    cities = [{ name, days: totalDays }];
  } else {
    const cityInputs = citiesContainer.querySelectorAll('.city-entry');
    cities = Array.from(cityInputs).map(entry => {
      const name = entry.querySelector('.city-name').value.trim();
      const days = parseInt(entry.querySelector('.city-days').value);
      return { name, days };
    });
    destination = cities.map(city => `${city.name} (${city.days}d)`).join(', ');
  }

  // Disable unused multi-city inputs if single-city mode is active
  if (!cityToggle.checked) {
    const hiddenInputs = multiCityWrapper.querySelectorAll('input');
    hiddenInputs.forEach(input => input.disabled = true);
  }

  // Send plan to server
  fetch('/api/plan', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      destination,
      cities,
      startDate,
      endDate,
      country,
    }),
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update current plan UI - INCLUDE COUNTRY
        planDestination.textContent = country ? `${destination} in ${country}` : destination;
        planDates.textContent = formatDateRange(startDate, endDate);
        currentPlanAlert.style.display = 'block';

        if (isUpdating) {
          // Show update confirmation popup
          showCustomMessage('Success', 'Your trip plan has been updated successfully!');
          
          // Reset the form modified state (to change button back to "Start Planning")
          const formModified = false;
          const submitButton = document.querySelector('#plan-form button[type="submit"]');
          submitButton.textContent = 'Start Planning';
          submitButton.classList.remove('btn-success');
          submitButton.classList.add('btn-primary');
        } else {
          // For new plans, redirect to attractions as before
          // Show forecast (optional)
          fetch(`/api/weather?city=${encodeURIComponent(destination)}`)
            .then(res => res.json())
            .then(weatherData => {
              showWeatherForDateRange(weatherData.forecast, startDate, endDate);
            });

          // Redirect to attractions
          window.location.href = '/attractions';
        }
      } else {
        console.error('Plan submission failed:', data);
        alert('Failed to save plan.');
      }
    })
    .catch(error => {
      console.error('Error saving plan:', error);
      alert('Error saving plan.');
    });
});

// Add a new function to show a custom success message popup
function showCustomMessage(title, message) {
  // Create modal backdrop
  const modalBackdrop = document.createElement('div');
  modalBackdrop.className = 'modal-backdrop';
  
  // Create modal content
  const modalContent = document.createElement('div');
  modalContent.className = 'custom-modal';
  
  // Add modal content
  modalContent.innerHTML = `
    <div class="modal-icon">
      <i class="bi bi-check-circle" style="color: #66ff99;"></i>
    </div>
    <h3 class="modal-title">${title}</h3>
    <p class="modal-message">${message}</p>
    <div class="modal-buttons">
      <button class="modal-btn" id="confirmOk" style="background: linear-gradient(135deg, #00c6ff, #0072ff); color: white;">OK</button>
    </div>
  `;
  
  // Add modal to DOM
  modalBackdrop.appendChild(modalContent);
  document.body.appendChild(modalBackdrop);
  
  // Add event listener to OK button
  document.getElementById('confirmOk').addEventListener('click', function() {
    document.body.removeChild(modalBackdrop);
  });
  
  // Close on backdrop click
  modalBackdrop.addEventListener('click', function(e) {
    if (e.target === modalBackdrop) {
      document.body.removeChild(modalBackdrop);
    }
  });
  
  // Close on Escape key
  const keyHandler = function(e) {
    if (e.key === 'Escape' || e.key === 'Enter') {
      document.body.removeChild(modalBackdrop);
      document.removeEventListener('keydown', keyHandler);
    }
  };
  document.addEventListener('keydown', keyHandler);
}

attachCityDaysListeners();

// Function to set up change detection on all form inputs
function setupChangeDetection() {
  // Get the submit button
  const submitButton = document.querySelector('#plan-form button[type="submit"]');
  
  // Original button styles (save these for reference)
  const originalButtonText = 'Start Planning';
  const originalButtonClass = 'btn-primary';
  
  // Change flag to track if form has been modified
  let formModified = false;
  
  // Trip exists flag - we'll set this based on the presence of the current plan alert
  let tripExists = document.getElementById('current-plan-alert').style.display !== 'none';
  
  // Function to update button appearance
function updateButtonAppearance() {
  // Only show "Update Plan" if a trip exists AND the form was modified
  if (tripExists && formModified) {
    // Change to "Update Plan" and green style
    submitButton.textContent = 'Update Plan';
    submitButton.classList.remove(originalButtonClass);
    submitButton.classList.add('btn-success');
    
    // Ensure the same hover and glow effects as the original button
    submitButton.style.background = 'linear-gradient(135deg, #00e676, #00c853)';
    submitButton.style.border = 'none';
    submitButton.style.fontWeight = '600';
    submitButton.style.boxShadow = '0 6px 20px rgba(0, 200, 83, 0.5)';
    submitButton.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
  } else {
    // Restore original appearance
    submitButton.textContent = originalButtonText;
    submitButton.classList.remove('btn-success');
    submitButton.classList.add(originalButtonClass);
    
    // Reset any inline styles we may have applied
    submitButton.style.background = '';
    submitButton.style.border = '';
    submitButton.style.fontWeight = '';
    submitButton.style.boxShadow = '';
    submitButton.style.transition = '';
  }
}
  
  // Function to handle input changes
  function handleInputChange() {
    formModified = true;
    updateButtonAppearance();
  }
  
  // Add event listeners to all form inputs
  const formInputs = document.querySelectorAll('#plan-form input, #plan-form select, #plan-form textarea');
  formInputs.forEach(input => {
    input.addEventListener('input', handleInputChange);
    input.addEventListener('change', handleInputChange);
  });
  
  // Also detect changes when add/remove city buttons are clicked
  const addCityBtn = document.getElementById('add-city-btn');
  if (addCityBtn) {
    addCityBtn.addEventListener('click', handleInputChange);
  }
  
  // For city removal, use event delegation since these elements are dynamic
  const citiesContainer = document.getElementById('cities-container');
  if (citiesContainer) {
    citiesContainer.addEventListener('click', e => {
      if (e.target.classList.contains('remove-city')) {
        handleInputChange();
      }
    });
  }
  
  // Handle the city toggle switch
  const cityToggle = document.getElementById('city-selection-toggle');
  if (cityToggle) {
    cityToggle.addEventListener('change', handleInputChange);
  }
  
  // Reset modified state after form submission
  document.getElementById('plan-form').addEventListener('submit', () => {
    formModified = false;
    updateButtonAppearance();
  });
  
  // Function to add listener to dynamically added city inputs
  function addListenersToDynamicInputs() {
    const cityInputs = document.querySelectorAll('.city-name, .city-days');
    cityInputs.forEach(input => {
      // Remove existing listeners to prevent duplicates
      input.removeEventListener('input', handleInputChange);
      input.removeEventListener('change', handleInputChange);
      
      // Add listeners
      input.addEventListener('input', handleInputChange);
      input.addEventListener('change', handleInputChange);
    });
  }
  
  // Make this function globally available
  window.addListenersToDynamicInputs = addListenersToDynamicInputs;
  
  // Initial call to ensure existing inputs have listeners
  addListenersToDynamicInputs();
  
  // Update trip exists flag when plan changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'style') {
        tripExists = document.getElementById('current-plan-alert').style.display !== 'none';
        updateButtonAppearance();
      }
    });
  });
  
  const currentPlanAlert = document.getElementById('current-plan-alert');
  if (currentPlanAlert) {
    observer.observe(currentPlanAlert, { attributes: true });
  }
}

// Call setup function
setupChangeDetection();

// Modify the existing addCityEntry function to add our change listeners
const originalAddCityEntry = addCityEntry;
addCityEntry = function() {
  // Call the original function
  originalAddCityEntry();
  
  // Add our listeners to the new inputs
  if (window.addListenersToDynamicInputs) {
    window.addListenersToDynamicInputs();
  }
};

  // Add this at the very end of the function
  setupClearPlanButton();
  
});


document.getElementById('get-weather-btn').addEventListener('click', () => {
  const city = document.getElementById('weather-city').value.trim();
  const resultList = document.getElementById('weather-results');
  resultList.innerHTML = '';

  if (!city) return alert('Please enter a city');

  fetch(`/api/weather?city=${encodeURIComponent(city)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.forecast || data.forecast.length === 0) {
        resultList.innerHTML = '<li class="list-group-item">No rain forecasted in the next 5 days.</li>';
        return;
      }

      data.forecast.forEach(entry => {
        const item = document.createElement('li');
        item.className = 'list-group-item';
        item.innerHTML = `
          <strong>${new Date(entry.datetime).toLocaleString()}</strong><br>
          ☔ <strong>Rain:</strong> ${entry.rainVolume} mm<br>
          🌡️ <strong>Temp:</strong> ${entry.temp}°C<br>
          🌤️ <strong>Forecast:</strong> ${entry.weather}
        `;
        resultList.appendChild(item);
      });
    })
    .catch(err => {
      console.error(err);
      resultList.innerHTML = '<li class="list-group-item text-danger">Error fetching weather data.</li>';
    });
});



  </script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const text = "Plan Your Perfect Trip";
    const element = document.getElementById("typewriter-text");
    let index = 0;
  
    function type() {
      if (index < text.length) {
        element.textContent += text.charAt(index);
        index++;
        setTimeout(type, 100); // typing speed
      }
    }
  
    type();
  });
  </script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="/js/weather.js"></script>
<script>
  // Fetch current plan
  fetch('/api/plan')
    .then(res => res.json())
    .then(data => {
      if (data.plan && data.plan.destination) {
        const { destination, startDate, endDate } = data.plan;
        fetch(`/api/weather?city=${encodeURIComponent(destination)}`)
          .then(res => res.json())
          .then(weatherData => {
            showWeatherForDateRange(weatherData.forecast, startDate, endDate, '.main-content');
          });
      }
    })
    .catch(err => console.error('Weather load error:', err));
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const scrollElements = document.querySelectorAll('[data-scroll]');
  
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('scrolled');
        }
      });
    }, { threshold: 0.2 });
  
    scrollElements.forEach(el => observer.observe(el));
  });
  </script>

  
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const brandText = "One Click Planner";
      const target = document.getElementById("brand-text");
  
      let i = 0;
      setTimeout(() => {
        const typeInterval = setInterval(() => {
          if (i < brandText.length) {
            target.textContent += brandText.charAt(i);
            target.style.opacity = 1;
            i++;
          } else {
            clearInterval(typeInterval);
          }
        }, 80); // speed of typing
      }, 1400); // wait until logo finishes bounce
    });
  </script>
  


<script src="/js/auth.js"></script>
</body>
</html>