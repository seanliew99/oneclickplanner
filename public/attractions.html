<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attractions - Travel Planner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
body {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(to bottom right, #0a0f1f, #1a2b55); /* dark navy to rich blue */
}

    
    .main-content {
      flex: 1;
    }

    .navbar {
      position: sticky;
  top: 0;
  z-index: 1000;
  background-color: rgba(15, 15, 20, 0.6) !important;
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  transition: background-color 0.4s ease;
}
.nav-tabs .nav-link {
  background-color: transparent;
  color: white;
  border: 1px solid #ff1f4b44;
  transition: all 0.3s ease;
}

.nav-link.active {
  color: #d858c7 !important;
  text-shadow: 0 0 10px #d858c7;
}

.nav-tabs .nav-link {
  background-color: transparent;
  color: white;
  border: 1px solid #ff1f4b44;
  transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
  background-color: rgba(255, 31, 75, 0.1);
  color: #ff1f4b;
}

.logo-img {
  width: 80px;
  height: auto;
  border-radius: 12px;
  object-fit: contain;
  background-color: transparent;
 
}

    
.navbar-brand {
  font-size: 2rem;
  font-weight: 700;
  color: #4db8ff !important; /* nice glowing blue */
  text-shadow: 0 0 10px #4db8ff88;
}


.nav-link:hover {
  color: #ff1f4b !important;
  text-shadow: 0 0 10px #ff1f4b88;
}


/* Active tab (Day 1, etc.) */
.nav-tabs .nav-link.active,
.nav-tabs .nav-link:focus,
.nav-tabs .nav-link.show {
  background-color: #000 !important;
  color: white !important;
  border: none !important;
  box-shadow: 0 0 8px #000;
  font-weight: bold;
}

/* Inactive tabs — clean and minimal */
.nav-tabs .nav-link {
  background-color: transparent;
  color: white;
  border: none;
  transition: all 0.3s ease;
  font-weight: 500;
}

/* Optional: On hover, a soft black background */
.nav-tabs .nav-link:hover {
  background-color: rgba(0, 0, 0, 0.3);
  color: #ff1f4b;
}

body, h1, h2, h3, h4, h5, h6, p, label, .form-label, .card-title, .card-text, .nav-link, .lead {
  color: white !important;
}

    .page-header {
      background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://source.unsplash.com/1600x900/?landmark,attraction');
      background-size: cover;
      background-position: center;
      color: white;
      padding: 60px 0;
      margin-bottom: 30px;
    }
    
    .search-container {
  background-color: rgba(255, 255, 255, 0.05); /* translucent dark */
  color: white;
  backdrop-filter: blur(12px);
  border: none;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
  padding: 20px;
}

.search-container input,
.search-container .form-control {
  background-color: rgba(0, 0, 0, 0.4);
  color: white;
  border: none;
}

.search-container input::placeholder {
  color: rgba(255, 255, 255, 0.6);
}

.search-container .form-check-label {
  color: rgb(44, 31, 161);
}


    
    #map {
      height: 400px;
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .attraction-card {
  background: rgba(255, 255, 255, 0.05); /* dark glassy look */
  backdrop-filter: blur(10px);
  border: none;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  color: white;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  height: 100%;
}

.attraction-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 0 16px rgba(255, 31, 75, 0.4), 0 0 40px rgba(255, 31, 75, 0.3);
  border: 1px solid #ff1f4b88;
}

    
    .attraction-image {
      height: 180px;
      background-size: cover;
      background-position: center;
    }
    
    .rating {
      color: #ffc107;
    }
    
    .no-plan-alert {
      margin-bottom: 30px;
    }
    
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .place-photo {
      width: 100%;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    footer {
      background-color: #343a40;
      color: white;
      padding: 20px 0;
      margin-top: auto;
    }
    
    .result-count {
      font-weight: 600;
      color: #6c757d;
      margin-bottom: 20px;
    }
    
    /* Loading spinner */
    .spinner-container {
      display: flex;
      justify-content: center;
      margin: 50px 0;
    }
    
    .btn-save {
      background-color: #28a745;
      color: white;
    }
    
    .btn-save:hover {
      background-color: #218838;
      color: white;
    }

    .tab-pane .card {
  background: rgba(255, 255, 255, 0.05); /* translucent dark glass */
  backdrop-filter: blur(10px);
  border: none;
  color: white;
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.4);
}

.list-group-item {
  background-color: rgba(0, 0, 0, 0.4); /* dark transparent background */
  color: white;
  border: none;
  transition: background-color 0.3s ease;
}

.list-group-item:hover {
  background-color: rgba(255, 31, 75, 0.08); /* subtle red glow on hover */
}

.result-count {
  font-weight: 600;
  color: white;
  background-color: rgba(0, 0, 0, 0.3); /* subtle dark background */
  padding: 10px 16px;
  border-radius: 8px;
  box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
  display: inline-block;
}


.modal-content {
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border: none;
  border-radius: 12px;
  backdrop-filter: blur(16px);
  box-shadow: 0 0 20px rgba(255, 31, 75, 0.2);
}

.modal-header,
.modal-body,
.modal-footer {
  border: none;
  color: white;
}

.modal-title {
  color: #ff1f4b;
  text-shadow: 0 0 8px #ff1f4b88;
}

.modal-body .form-control {
  background-color: rgba(255, 255, 255, 0.05);
  color: white;
  border: 1px solid #ff1f4b44;
}

.modal-body .form-control::placeholder {
  color: rgba(255, 255, 255, 0.6);
}

.modal-body a {
  color: #ff4b6e;
  text-decoration: underline;
}

.modal-body a:hover {
  color: #ff1f4b;
}

.modal-body ul {
  padding-left: 1rem;
}

.modal-body li {
  color: white;
  margin-bottom: 4px;
}

.rating {
  color: #ffc107;
  font-weight: bold;
}

#typewriter-attractions::after {
  content: '|';
  animation: blink 0.8s infinite;
  margin-left: 2px;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50%      { opacity: 0; }
}

#map {
  max-width: 100%;
  height: 400px;
  margin-bottom: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
}



img[src="/assets/logo.png"] {
  background-color: black;
  padding: 8px;
  border-radius: 12px;
  object-fit: contain;
}


  </style>
</head>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const currentPath = window.location.pathname;

    // Loop through each nav link
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
      const linkPath = new URL(link.href).pathname;

      // Match path and apply 'active' class
      if (linkPath === currentPath || (linkPath === "/" && currentPath === "/index.html")) {
        link.classList.add('active');
        link.style.color = "#ff1f4b"; // optional: override color
        link.style.textShadow = "0 0 10px #ff1f4baa";
      } else {
        link.classList.remove('active');
      }
    });
  });
</script>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <img src="/assets/logo.png" alt="Logo" class="logo-img" />
        One Click Planner
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/attractions">Attractions</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/restaurants">Restaurants</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/flights">Flights</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/hotels">Hotels</a>
          </li>
          <!-- Auth buttons -->
          <li class="nav-item ms-3">
            <a class="btn btn-outline-light" href="https://us-east-1zjt65d7ot.auth.us-east-1.amazoncognito.com/login?client_id=3anj5rhtknc7i97jq3jgknai71&response_type=code&scope=email+openid+phone&redirect_uri=http%3A%2F%2Flocalhost%3A3000">Login</a>
          </li>
          <li class="nav-item ms-2">
            <a class="btn btn-outline-light" href="https://us-east-1zjt65d7ot.auth.us-east-1.amazoncognito.com/signup?client_id=3anj5rhtknc7i97jq3jgknai71&redirect_uri=http%3A%2F%2Flocalhost%3A3000&response_type=code&scope=email+openid+phone">Sign Up</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Page Header -->
    <header class="page-header text-center">
      <div class="container">
        <h1 class="display-4"><span id="typewriter-attractions"></span></h1>

        <p class="lead">Find the best places to visit at your destination</p>
      </div>
    </header>

    <div class="container">
      <!-- No Plan Alert -->
      <div id="no-plan-alert" class="alert alert-warning no-plan-alert" role="alert" style="display: none;">
        <h4 class="alert-heading">No destination selected!</h4>
        <p>It looks like you haven't set a destination for your trip yet.</p>
        <hr>
        <p class="mb-0">
          <a href="/" class="btn btn-warning">Create a Trip Plan</a>
        </p>
      </div>

      <!-- Current Plan Info -->
      <div id="current-plan-info" class="mb-4" style="display: none;">
        <h2>Finding Attractions in <span id="destination-display"></span></h2>
        <p id="date-display" class="text-muted"></p>
      </div>
      <!-- Dynamic Day Tabs Section -->
      <section class="mt-4" id="itinerary-section" style="display: none;">
        <h4 class="mb-3">Recommended Attractions For Each Day</h4>
        <ul class="nav nav-tabs" id="dayTabs" role="tablist"></ul>
        <div class="tab-content pt-3" id="dayTabsContent"></div>
      </section>

      <!-- Search Container -->
      <div class="search-container mb-4">
        <form id="search-form" class="row g-3 align-items-end">
          <div class="col-md-8">
            <label for="keyword" class="form-label">Search Attractions</label>
            <input type="text" class="form-control form-control-lg" id="keyword" placeholder="Museum, park, landmark, etc.">
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-primary btn-lg w-100">Search</button>
          </div>
        </form>
        <!-- Weather-based filter toggle -->
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="indoor-toggle">
          <label class="form-check-label" for="indoor-toggle">
            Show indoor attractions ☔
          </label>
        </div>
      </div>

      <!-- Map and Results Container -->
      <div class="row">
        <!-- Map Column -->
        <div class="text-center mb-4">
          <div id="map" style="max-width: 800px; margin: 0 auto;"></div>
        </div>
        
        <div class="text-center">
          <div id="result-count" class="result-count"></div>
        </div>
        
        <div id="spinner" class="spinner-container" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        
        <div id="results-container" class="row g-4 justify-content-center"></div>
        
    </div>
  </div>

  <!-- Attraction Details Modal -->
  <div class="modal fade" id="attractionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-title">Attraction Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modal-body">
          <!-- Content will be dynamically inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-save" id="save-attraction-btn">Add to Itinerary</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center py-4">
    <div class="container">
      <p class="mb-0">© 2025 Travel Planner. All rights reserved.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>

    
let apiKey = '';

fetch('/api/config')
  .then(res => res.json())
  .then(config => {
    apiKey = config.apiKey;
    console.log("✅ API Key Loaded:", apiKey);
    // Load the Google Maps script with the API key
    loadGoogleMapsScript(apiKey);
    // 🔥 Now kick off your app logic
    loadCurrentPlan();  // or initMap(), or searchAttractions()
  })
  .catch(err => {
    console.error("❌ Failed to load API key:", err);
  });



    let map;
    let searchMarkers = [];
    let recommendedMarkers = [];
    let recommendedPlaceIds = new Set();
    let currentPlan = null;
    let selectedPlace = null;
    let rainDays = [];
    let isMapDragging = false;
    let debounceTimer = null;
    let currentMapBounds = null;
    let selectedPlaceForDaySelection = null;

    // Global object to hold pre-fetched recommendations per day
    const itineraryRecommendations = {}; 
    const removedAttractions = new Set();
    const attractionModal = new bootstrap.Modal(document.getElementById('attractionModal'));

    // ----- Helper Functions for Clustering -----
    function haversineDistance(a, b) {
      const latA = typeof a.lat === 'function' ? a.lat() : a.lat;
      const lngA = typeof a.lng === 'function' ? a.lng() : a.lng;
      const latB = typeof b.lat === 'function' ? b.lat() : b.lat;
      const lngB = typeof b.lng === 'function' ? b.lng() : b.lng;
      const R = 6371;
      const dLat = (latB - latA) * Math.PI / 180;
      const dLng = (lngB - lngA) * Math.PI / 180;
      const aCalc = Math.sin(dLat/2) ** 2 +
                    Math.cos(latA * Math.PI/180) * Math.cos(latB * Math.PI/180) *
                    Math.sin(dLng/2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(aCalc), Math.sqrt(1 - aCalc));
    }

    // Returns at most maxCount attractions that are close to each other (within threshold km)
    function filterRecommendations(recs, maxCount = 5, threshold = 5) {
      if (recs.length <= maxCount) return recs;
      let bestCluster = [];
      for (let i = 0; i < recs.length; i++) {
        if (!recs[i].geometry || !recs[i].geometry.location) continue;
        let cluster = [recs[i]];
        for (let j = 0; j < recs.length; j++) {
          if (i === j) continue;
          if (!recs[j].geometry || !recs[j].geometry.location) continue;
          const dist = haversineDistance(recs[i].geometry.location, recs[j].geometry.location);
          if (dist < threshold) {
            cluster.push(recs[j]);
          }
        }
        if (cluster.length > bestCluster.length) {
          bestCluster = cluster;
        }
      }
      if (bestCluster.length === 0) return recs.slice(0, maxCount);
      const seed = bestCluster[0];
      bestCluster.sort((a, b) => haversineDistance(seed.geometry.location, a.geometry.location) - haversineDistance(seed.geometry.location, b.geometry.location));
      return bestCluster.slice(0, maxCount);
    }
    // ----- End Helper Functions -----

    function formatDateRange(startDate, endDate) {
      if (!startDate && !endDate) return 'Dates not specified';
      if (!startDate) return `Until ${new Date(endDate).toLocaleDateString()}`;
      if (!endDate) return `From ${new Date(startDate).toLocaleDateString()}`;
      return `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`;
    }

    function initMap() {
      const defaultLocation = { lat: 0, lng: 0 };
      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLocation,
        zoom: 2,
        mapTypeControl: false,
        fullscreenControl: true,
        streetViewControl: false,
      });
      
      map.addListener('dragstart', function() {
        isMapDragging = true;
      });
      
      map.addListener('dragend', function() {
        isMapDragging = false;
        debouncedSearchByMapBounds();
      });
      
      map.addListener('zoom_changed', function() {
        debouncedSearchByMapBounds();
      });
      
      loadCurrentPlan();
    }

    function debouncedSearchByMapBounds() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(searchAttractionsByMapBounds, 500);
    }

    function searchAttractionsByMapBounds() {
      const bounds = map.getBounds();
      if (!bounds) return;
      currentMapBounds = bounds;
      const center = map.getCenter();
      const lat = center.lat();
      const lng = center.lng();
      document.getElementById('spinner').style.display = 'flex';
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: { lat, lng } }, function(results, status) {
        if (status === 'OK' && results[0]) {
          let locationName = '';
          for (let component of results[0].address_components) {
            if (component.types.includes('locality')) {
              locationName = component.long_name;
              break;
            } else if (component.types.includes('administrative_area_level_1') && !locationName) {
              locationName = component.long_name;
            }
          }
          if (locationName) {
            let mapAreaHeading = document.getElementById('map-area-heading');
            if (!mapAreaHeading) {
              const headingDiv = document.createElement('div');
              headingDiv.id = 'map-area-heading';
              headingDiv.className = 'alert alert-info mb-3';
              headingDiv.innerHTML = `<i class="bi bi-geo-alt"></i> Showing attractions in <strong>${locationName}</strong>`;
              const searchContainer = document.querySelector('.search-container');
              searchContainer.parentNode.insertBefore(headingDiv, searchContainer.nextSibling);
            } else {
              mapAreaHeading.innerHTML = `<i class="bi bi-geo-alt"></i> Showing attractions in <strong>${locationName}</strong>`;
            }
            searchAttractionsByLocation(locationName);
          }
        } else {
          console.log('Geocoder failed due to: ' + status);
          searchAttractions('');
        }
      });
    }

    function searchAttractionsByLocation(location) {
      clearSearchMarkers();
      document.getElementById('spinner').style.display = 'flex';
      document.getElementById('results-container').innerHTML = '';
      document.getElementById('result-count').textContent = '';
      const keyword = document.getElementById('keyword').value;
      fetch(`/api/places?location=${encodeURIComponent(location)}&type=attraction&keyword=${encodeURIComponent(keyword)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('spinner').style.display = 'none';
          if (data.status === 'OK' && data.results && data.results.length > 0) {
            document.getElementById('result-count').textContent = `Found ${data.results.length} attractions`;
            displayResults(data.results);
          } else {
            document.getElementById('results-container').innerHTML = `
              <div class="alert alert-info">
                No attractions found in ${location}. Try searching with different keywords.
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error searching attractions:', error);
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('results-container').innerHTML = `
            <div class="alert alert-danger">
              Error searching for attractions. Please try again later.
            </div>
          `;
        });
    }

    function originalSearchAttractions(keyword, locationOverride) {
      if (!currentPlan || !currentPlan.destination) return;
      document.getElementById('spinner').style.display = 'flex';
      document.getElementById('results-container').innerHTML = '';
      document.getElementById('result-count').textContent = '';
      clearSearchMarkers();
      
      let location = locationOverride || currentPlan.destination;

      // Clean the location string
      if (typeof location === 'string') {
        // If it's a comma-separated list, just use the first city's name
        if (location.includes(',')) {
          let firstCity = location.split(',')[0].trim();
          if (firstCity.includes('(')) {
            firstCity = firstCity.split('(')[0].trim();
          }
          location = firstCity;
        } else if (location.includes('(')) {
          location = location.split('(')[0].trim();
        }
      }

      console.log('Searching in:', location, 'Keyword:', keyword);
      fetch(`/api/places?location=${encodeURIComponent(location)}&type=attraction&keyword=${encodeURIComponent(keyword)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('spinner').style.display = 'none';
          if (data.status === 'OK' && data.results && data.results.length > 0) {
            document.getElementById('result-count').textContent = `Found ${data.results.length} attractions`;
            displayResults(data.results);
            const bounds = new google.maps.LatLngBounds();
            searchMarkers.forEach(marker => bounds.extend(marker.getPosition()));
            map.fitBounds(bounds);
          } else {
            document.getElementById('results-container').innerHTML = `
              <div class="alert alert-info">
                No attractions found. Try a different search term.
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error searching attractions:', error);
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('results-container').innerHTML = `
            <div class="alert alert-danger">
              Error searching for attractions. Please try again later.
            </div>
          `;
        });
    }

    function addResetMapButton() {
      const mapElement = document.getElementById('map');
      const resetButton = document.createElement('button');
      resetButton.id = 'reset-map-button';
      resetButton.className = 'btn btn-sm btn-light position-absolute m-2';
      resetButton.style.zIndex = '1';
      resetButton.style.top = '10px';
      resetButton.style.right = '10px';
      resetButton.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Reset Map';
      
      resetButton.addEventListener('click', function() {
        currentMapBounds = null;
        const mapAreaHeading = document.getElementById('map-area-heading');
        if (mapAreaHeading) {
          mapAreaHeading.remove();
        }
        searchAttractions('');
      });
      
      const mapContainer = mapElement.parentNode;
      mapContainer.style.position = 'relative';
      mapContainer.appendChild(resetButton);
    }

    function addDaySelectionModal() {
      if (!document.getElementById('daySelectionModal')) {
        const modalHTML = `
          <div class="modal fade" id="daySelectionModal" tabindex="-1" aria-labelledby="daySelectionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="daySelectionModalLabel">Choose Day to Add Attraction</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>Select which day you'd like to add <strong id="place-name-display"></strong> to:</p>
                  <div id="day-selection-buttons" class="d-grid gap-2">
                    <!-- Buttons will be dynamically inserted here -->
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        `;
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);
      }
    }

    function centerMapOnRecommended(dayIndex) {
      // Gather all recommended markers that belong to the chosen day
      const bounds = new google.maps.LatLngBounds();
      let foundAny = false;

      recommendedMarkers.forEach(obj => {
        if (obj.dayIndex === dayIndex) {
          bounds.extend(obj.marker.getPosition());
          foundAny = true;
        }
      });

      // Only fitBounds if there’s at least one recommended marker for that day
      if (foundAny) {
        map.fitBounds(bounds);
      }
    }

    // Generate itinerary tabs using pre-fetched recommendations.
    // Before generating, for days with the same city, remove duplicates already used in an earlier day.
    function generateItineraryTabs() {
      document.getElementById('itinerary-section').style.display = 'block';
      const dayTabs = document.getElementById('dayTabs');
      const dayTabsContent = document.getElementById('dayTabsContent');
      dayTabs.innerHTML = '';
      dayTabsContent.innerHTML = '';
      
      // Remove duplicate recommendations across days that have the same city.
      const cityUsed = {}; // city => set of place_ids used in earlier days
      for (let i = 0; i < currentPlan.perDayCityMap.length; i++) {
        const city = currentPlan.perDayCityMap[i];
        if (!cityUsed[city]) {
          cityUsed[city] = new Set();
        }
        // Remove attractions already used in this city on previous days.
        itineraryRecommendations[i] = (itineraryRecommendations[i] || []).filter(place => {
          return !cityUsed[city].has(place.place_id);
        });
        // Apply clustering to limit to max 5.
        itineraryRecommendations[i] = filterRecommendations(itineraryRecommendations[i], 5, 5);
        itineraryRecommendations[i].forEach(place => cityUsed[city].add(place.place_id));
      }
      
      const startDate = new Date(currentPlan.startDate);
      const totalDays = currentPlan.perDayCityMap.length;
      
      for (let i = 0; i < totalDays; i++) {
        const currentDay = new Date(startDate);
        currentDay.setDate(startDate.getDate() + i);
        const dateLabel = currentDay.toLocaleDateString();
        const dayCity = currentPlan.perDayCityMap[i];
        const tabId = `day${i + 1}`;
        const isActive = i === 0 ? 'active' : '';
        const isShow = i === 0 ? 'show active' : '';
        
        const tab = document.createElement('li');
        tab.className = 'nav-item';
        tab.innerHTML = `
          <button class="nav-link ${isActive}" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" type="button" role="tab">
            Day ${i + 1} (${dateLabel}) - ${dayCity}
          </button>
        `;
        dayTabs.appendChild(tab);
        
        const recs = itineraryRecommendations[i] || [];
        const listItems = recs.map(place => `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            ${place.name}
            <button class="btn btn-sm btn-outline-success recommended-add-btn"
              data-place-id="${place.place_id}" 
              data-day-index="${i}">
              Add to Itinerary
            </button>
          </li>
        `).join('');
        
        const pane = document.createElement('div');
        pane.className = `tab-pane fade ${isShow}`;
        pane.id = tabId;
        pane.role = 'tabpanel';
        pane.innerHTML = `
          <div class="card p-3">
            <h5>Recommended Places in ${dayCity}</h5>
            <ul class="list-group">${listItems || '<li class="list-group-item text-muted">No recommendations yet.</li>'}</ul>
          </div>
        `;
        dayTabsContent.appendChild(pane);

        tab.querySelector('button.nav-link').dataset.dayIndex = i; // store the day index

        tab.querySelector('button.nav-link').addEventListener('click', function() {
          const dayIndex = parseInt(this.dataset.dayIndex, 10);
          centerMapOnRecommended(dayIndex);
        });
      }
            
      // Add "Add All Recommendations" button to section title
      const sectionTitle = document.querySelector('#itinerary-section h4');
      if (sectionTitle) {
        sectionTitle.innerHTML = `
          <div class="d-flex justify-content-between align-items-center w-100">
            <span>Recommended Attractions For Each Day</span>
            <button id="add-all-recommendations" class="btn btn-success btn-sm">
              <i class="bi bi-plus-circle me-1"></i>Add All to Itinerary
            </button>
          </div>
        `;
      } else {
        const header = document.createElement('h4');
        header.className = 'mb-3';
        header.innerHTML = `
          <div class="d-flex justify-content-between align-items-center w-100">
            <span>Recommended Attractions For Each Day</span>
            <button id="add-all-recommendations" class="btn btn-success btn-sm">
              <i class="bi bi-plus-circle me-1"></i>Add All to Itinerary
            </button>
          </div>
        `;
        itinerarySection.prepend(header);
      }
      setupRecommendedButtons();
      setupAddAllButton();
    }

    function computePerDayCityMap(plan) {
      const perDayCityMap = [];
      if (plan.cities && plan.cities.length > 0) {
        plan.cities.forEach(city => {
          // Extract just the city name if it contains parentheses (like "Tokyo (2d)")
          const cityName = typeof city.name === 'string' && city.name.includes('(') 
            ? city.name.split('(')[0].trim() 
            : city.name;
            
          for (let i = 0; i < city.days; i++) {
            perDayCityMap.push(cityName);
          }
        });
      } else {
        // For plans without explicit cities array, create entries based on date range
        const start = new Date(plan.startDate);
        const end = new Date(plan.endDate);
        const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        
        // Extract just the destination name if it contains parentheses or commas
        let destinationName = plan.destination;
        if (typeof destinationName === 'string') {
          // Handle comma-separated list like "Tokyo (2d), Osaka (2d)"
          if (destinationName.includes(',')) {
            const destinations = destinationName.split(',');
            for (let i = 0; i < totalDays; i++) {
              // Distribute days evenly among destinations (simplified approach)
              const destIndex = Math.min(Math.floor(i / Math.ceil(totalDays / destinations.length)), destinations.length - 1);
              let dest = destinations[destIndex].trim();
              // Remove any day notation like "(2d)"
              if (dest.includes('(')) {
                dest = dest.split('(')[0].trim();
              }
              perDayCityMap.push(dest);
            }
            return perDayCityMap;
          }
          // Handle single destination with days notation like "Tokyo (2d)"
          else if (destinationName.includes('(')) {
            destinationName = destinationName.split('(')[0].trim();
          }
        }
        
        // Use the clean destination name for all days
        for (let i = 0; i < totalDays; i++) {
          perDayCityMap.push(destinationName);
        }
      }
      return perDayCityMap;
    }

    function setupRecommendedButtons() {
      const buttons = document.querySelectorAll('.recommended-add-btn');
      buttons.forEach(button => {
        button.addEventListener('click', function() {
          const placeId = this.dataset.placeId;
          const place = findPlaceInRecommendations(placeId);
          if (!place) {
            console.error('Place not found in recommendations');
            return;
          }
          if (!checkAuthBeforeAddToItinerary(place)) return;
          selectedPlaceForDaySelection = {
            placeId: place.place_id,
            name: place.name,
            address: place.formatted_address || '',
            notes: '',
            indoor: document.getElementById('indoor-toggle').checked
          };
          fetch('/api/plan')
            .then(response => response.json())
            .then(data => {
              if (data.plan && data.plan.startDate && data.plan.endDate) {
                const startDate = new Date(data.plan.startDate);
                const endDate = new Date(data.plan.endDate);
                const dayCount = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('place-name-display').textContent = selectedPlaceForDaySelection.name;
                const buttonsContainer = document.getElementById('day-selection-buttons');
                buttonsContainer.innerHTML = '';
                for (let i = 0; i < dayCount; i++) {
                  const currentDay = new Date(startDate);
                  currentDay.setDate(startDate.getDate() + i);
                  const button = document.createElement('button');
                  button.type = 'button';
                  button.className = 'btn btn-outline-primary';
                  button.innerHTML = `Day ${i + 1} <small>(${currentDay.toLocaleDateString()})</small>`;
                  button.dataset.dayIndex = i;
                  button.addEventListener('click', function() {
                    addToItineraryForDay(selectedPlaceForDaySelection, i);
                    const daySelectionModal = bootstrap.Modal.getInstance(document.getElementById('daySelectionModal'));
                    daySelectionModal.hide();
                  });
                  buttonsContainer.appendChild(button);
                }
                const daySelectionModal = new bootstrap.Modal(document.getElementById('daySelectionModal'));
                daySelectionModal.show();
              } else {
                addToItineraryWithoutDay(selectedPlaceForDaySelection);
              }
            })
            .catch(error => {
              console.error('Error loading plan for day selection:', error);
              addToItineraryWithoutDay(selectedPlaceForDaySelection);
            });
        });
      });
    }

    function addAllRecommendationsToItinerary() {
      // Collect all recommendations
      const allRecommendations = [];
      
      // Gather recommendations from each day
      Object.entries(itineraryRecommendations).forEach(([dayIndex, places]) => {
        console.log(`Day ${dayIndex} has ${places ? places.length : 0} recommendations`);
        
        if (!places || !Array.isArray(places)) {
          console.error(`Invalid places for day ${dayIndex}:`, places);
          return;
        }
        
        places.forEach(place => {
          // Skip places that have been removed
          if (removedAttractions.has(place.place_id)) {
            console.log(`Skipping place ${place.name} (${place.place_id}) as it's in removedAttractions`);
            return;
          }
          
          // Check if place is valid
          if (!place || typeof place !== 'object') {
            console.error('Invalid place object:', place);
            return;
          }
          
          // Ensure required fields are present
          if (!place.place_id) {
            console.error('Missing place_id for place:', place);
            return; // Skip this place
          }
          
          allRecommendations.push({
            placeId: place.place_id,
            name: place.name || 'Unknown Place',
            address: place.formatted_address || '',
            category: 'attraction',
            notes: '',
            indoor: document.getElementById('indoor-toggle').checked,
            dayIndex: parseInt(dayIndex)
          });
        });
      });
      
      console.log('Total recommendations to add:', allRecommendations.length);
      
      if (allRecommendations.length === 0) {
        showNotification('warning', 'No recommendations available to add.');
        return;
      }
      
      // Show initial loading notification with progress bar
      const initialNotification = createNotification('info', `Adding ${allRecommendations.length} attractions to your itinerary...`);
      
      // Create a progress bar in the notification
      const progressBar = document.createElement('div');
      progressBar.className = 'progress mt-2';
      progressBar.innerHTML = `
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
            role="progressbar" 
            style="width: 0%" 
            aria-valuenow="0" 
            aria-valuemin="0" 
            aria-valuemax="100">0%</div>
      `;
      initialNotification.querySelector('.alert').appendChild(progressBar);
      
      // Process attractions one by one for maximum reliability
      addAttractionsOneByOne(allRecommendations, progressBar, initialNotification);
      
      // Function to add attractions one by one with progress bar
      function addAttractionsOneByOne(attractions, progressBar, notification) {
        let currentIndex = 0;
        let successCount = 0;
        let duplicateCount = 0;
        let errorCount = 0;
        
        function addNext() {
          if (currentIndex >= attractions.length) {
            // All done
            console.log(`Completed adding attractions. Success: ${successCount}, Duplicates: ${duplicateCount}, Errors: ${errorCount}`);
            
            // Update notification with success message
            if (successCount > 0) {
              let message = `Successfully added ${successCount} attractions to your itinerary!`;
              if (duplicateCount > 0) {
                message += ` (${duplicateCount} were already in your plan)`;
              }
              updateNotificationWithResult(notification, 'success', message);
            } else if (duplicateCount > 0 && errorCount === 0) {
              updateNotificationWithResult(notification, 'warning', 'All attractions were already in your itinerary.');
            } else if (errorCount > 0) {
              updateNotificationWithResult(notification, 'warning', 
                `Added ${successCount} attractions, but ${errorCount} failed. Check console for details.`);
            }
            
            // Reload the page after a short delay
            setTimeout(() => {
              window.location.reload();
            }, 2000);
            return;
          }
          
          const attraction = attractions[currentIndex];
          
          // Log progress
          console.log(`Adding ${currentIndex + 1}/${attractions.length}: ${attraction.name} (Day ${attraction.dayIndex})`);
          
          // Update progress bar
          updateProgress(progressBar, currentIndex, attractions.length);
          
          // Add the attraction
          fetch('/api/plan/places', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(attraction)
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`Server error ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              successCount++;
              console.log(`Successfully added: ${attraction.name}`);
            } else if (data.duplicate) {
              duplicateCount++;
              console.log(`Attraction already exists: ${attraction.name}`);
            } else {
              console.warn(`Unexpected response for ${attraction.name}:`, data);
              errorCount++;
            }
            
            // Move to next attraction
            currentIndex++;
            
            // Update progress bar
            updateProgress(progressBar, currentIndex, attractions.length);
            
            // Update notification message to show progress
            const progressMessage = `Adding attractions to your itinerary... (${currentIndex}/${attractions.length})`;
            updateNotificationMessage(notification, 'info', progressMessage, progressBar);
            
            // Wait a bit before next request to avoid overloading the server
            setTimeout(addNext, 300);
          })
          .catch(error => {
            errorCount++;
            console.error(`Error adding ${attraction.name}:`, error);
            
            // Continue to next attraction even if this one failed
            currentIndex++;
            
            // Update progress bar even on error
            updateProgress(progressBar, currentIndex, attractions.length);
            
            setTimeout(addNext, 300);
          });
        }
        
        // Start the process
        addNext();
      }
    }


    function setupAddAllButton() {
      const addAllBtn = document.getElementById('add-all-recommendations');
      if (!addAllBtn) return;
      addAllBtn.addEventListener('click', function() {
        const authUser = localStorage.getItem('authUser');
        if (!authUser) {
          showLoginRequiredModal();
          return;
        }
        checkItineraryStatus()
          .then(status => {
            if (status.hasItems) {
              showOverwriteConfirmationModal();
            } else {
              addAllRecommendationsToItinerary();
            }
          })
          .catch(error => {
            console.error('Error checking itinerary status:', error);
            showNotification('error', 'Failed to check current itinerary. Please try again.');
          });
      });
    }

    function checkItineraryStatus() {
      return fetch('/api/plan')
        .then(response => response.json())
        .then(data => {
          const hasAttractions = data.plan && data.plan.attractions && data.plan.attractions.length > 0;
          return { hasItems: hasAttractions, plan: data.plan };
        });
    }

    function showOverwriteConfirmationModal() {
      if (!document.getElementById('overwriteConfirmationModal')) {
        const modalHTML = `
          <div class="modal fade" id="overwriteConfirmationModal" tabindex="-1" aria-labelledby="overwriteConfirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-warning">
                  <h5 class="modal-title" id="overwriteConfirmationModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Warning: Existing Attractions
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>Your itinerary already contains attractions. What would you like to do?</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-danger" id="overwrite-btn">
                    <i class="bi bi-trash me-1"></i>Clear & Replace All
                  </button>
                  <button type="button" class="btn btn-primary" id="add-to-existing-btn">
                    <i class="bi bi-plus-circle me-1"></i>Add To Existing
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);
        document.getElementById('overwrite-btn').addEventListener('click', function() {
          clearItineraryAndAddAll();
          bootstrap.Modal.getInstance(document.getElementById('overwriteConfirmationModal')).hide();
        });
        document.getElementById('add-to-existing-btn').addEventListener('click', function() {
          addAllRecommendationsToItinerary();
          bootstrap.Modal.getInstance(document.getElementById('overwriteConfirmationModal')).hide();
        });
      }
      const overwriteModal = new bootstrap.Modal(document.getElementById('overwriteConfirmationModal'));
      overwriteModal.show();
    }

    function clearItineraryAndAddAll() {
      const loadingNotification = createNotification('info', 'Preparing to update your itinerary...');
      const progressBar = document.createElement('div');
      progressBar.className = 'progress mt-2';
      progressBar.innerHTML = `
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
            role="progressbar" 
            style="width: 0%" 
            aria-valuenow="0" 
            aria-valuemin="0" 
            aria-valuemax="100">0%</div>
      `;
      loadingNotification.querySelector('.alert').appendChild(progressBar);
      
      fetch('/api/plan')
        .then(response => response.json())
        .then(data => {
          if (!data.plan) {
            throw new Error('No active plan found');
          }
          const plan = data.plan;
          updateNotificationMessage(loadingNotification, 'info', 'Clearing existing attractions...');
          
          if (!plan.attractions || plan.attractions.length === 0) {
            updateNotificationMessage(loadingNotification, 'info', 'No existing attractions to clear. Adding recommendations...');
            // Remove the current notification before starting the next phase
            loadingNotification.remove();
            addAllRecommendationsToItinerary();
            return;
          }
          
          updateProgress(progressBar, 0, plan.attractions.length);
          
          const fastDeletePromise = fetch(`/api/plan/itinerary/${plan.itineraryId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Delete operation timeout')), 1000);
          });
          
          Promise.race([fastDeletePromise, timeoutPromise])
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to delete itinerary');
              }
              return response.json();
            })
            .then(() => {
              updateNotificationMessage(loadingNotification, 'success', 'Successfully cleared all attractions! Adding recommendations...');
              const newItineraryData = {
                destination: plan.destination,
                startDate: plan.startDate,
                endDate: plan.endDate
              };
              return fetch('/api/plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newItineraryData)
              });
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to create new itinerary');
              }
              return response.json();
            })
            .then(() => {
              // Important: Remove the notification completely before starting the next phase
              if (loadingNotification.parentNode) {
                loadingNotification.remove();
              }
              // Small delay to ensure UI updates correctly
              setTimeout(() => {
                addAllRecommendationsToItinerary();
              }, 100);
            })
            .catch(error => {
              console.log('Fast delete approach failed, falling back to sequential deletion:', error);
              updateNotificationMessage(loadingNotification, 'info', 'Clearing existing attractions...');
              deleteAttractionsSequentially(plan.attractions, 0, plan.attractions.length, progressBar, loadingNotification);
            });
        })
        .catch(error => {
          console.error('Error fetching plan:', error);
          updateNotificationWithResult(loadingNotification, 'error', 'Failed to fetch current itinerary. Please try again.');
          // Ensure the notification is removed after error
          setTimeout(() => {
            if (loadingNotification.parentNode) {
              loadingNotification.remove();
            }
          }, 3000);
        });
    }

    function deleteAttractionsSequentially(attractions, index, total, progressBar, notification) {
      if (!attractions || index >= attractions.length) {
        console.log('Finished deleting all attractions sequentially');
        updateNotificationMessage(notification, 'success', 'Successfully cleared all attractions! Adding recommendations...');
        
        // Important: Remove the notification completely before starting the next phase
        if (notification.parentNode) {
          notification.remove();
        }
        
        // Small delay to ensure UI updates correctly
        setTimeout(() => {
          addAllRecommendationsToItinerary();
        }, 100);
        return;
      }
      
      updateProgress(progressBar, index, total);
      const attraction = attractions[index];
      
      fetch(`/api/plan/places/${attraction.id}?category=attraction`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => {
        if (!response.ok) {
          console.warn(`Warning: Failed to delete attraction ${attraction.id}, continuing anyway`);
        }
        return response.json().catch(() => ({}));
      })
      .then(() => {
        console.log(`Deleted attraction ${index + 1}/${total}`);
        setTimeout(() => {
          deleteAttractionsSequentially(attractions, index + 1, total, progressBar, notification);
        }, 50);
      })
      .catch(error => {
        console.error(`Error deleting attraction ${attraction.id}:`, error);
        setTimeout(() => {
          deleteAttractionsSequentially(attractions, index + 1, total, progressBar, notification);
        }, 50);
      });
    }

    function updateProgress(progressBar, current, total) {
      const percentage = Math.round((current / total) * 100);
      const progressElement = progressBar.querySelector('.progress-bar');
      progressElement.style.width = `${percentage}%`;
      progressElement.setAttribute('aria-valuenow', percentage);
      progressElement.textContent = `${percentage}%`;
    }

    function createNotification(type, message) {
      const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';
      
      const iconClass = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-exclamation-triangle-fill',
        'warning': 'bi-exclamation-circle-fill',
        'info': 'bi-info-circle-fill'
      }[type] || 'bi-info-circle-fill';
      
      const alertContainer = document.createElement('div');
      alertContainer.className = 'position-fixed top-0 start-0 end-0 p-3 text-center';
      alertContainer.style.zIndex = '5000';
      alertContainer.innerHTML = `
        <div class="alert ${alertClass} fade show" role="alert">
          <i class="bi ${iconClass} me-2"></i>${message}
        </div>
      `;
      document.body.appendChild(alertContainer);
      return alertContainer;
    }

    function updateNotificationMessage(notificationElement, type, message, progressBar) {
      const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';
      
      const iconClass = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-exclamation-triangle-fill',
        'warning': 'bi-exclamation-circle-fill',
        'info': 'bi-info-circle-fill'
      }[type] || 'bi-info-circle-fill';
      
      const alertElement = notificationElement.querySelector('.alert');
      if (!alertElement) return;
      
      // Save progress bar if it exists
      const oldProgressBar = alertElement.querySelector('.progress');
      
      // Change alert class
      alertElement.className = `alert ${alertClass} fade show`;
      
      // Change icon and message
      alertElement.innerHTML = `<i class="bi ${iconClass} me-2"></i>${message}`;
      
      // Re-add progress bar if it exists
      if (oldProgressBar || progressBar) {
        alertElement.appendChild(progressBar || oldProgressBar);
      }
    }

    function updateNotificationWithResult(notificationElement, type, message) {
      const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';
      
      const iconClass = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-exclamation-triangle-fill',
        'warning': 'bi-exclamation-circle-fill',
        'info': 'bi-info-circle-fill'
      }[type] || 'bi-info-circle-fill';
      
      const alertElement = notificationElement.querySelector('.alert');
      if (!alertElement) return;
      const progressBar = alertElement.querySelector('.progress');
      if (progressBar) {
        progressBar.remove();
      }
      alertElement.className = `alert ${alertClass} fade show`;
      alertElement.innerHTML = `<i class="bi ${iconClass} me-2"></i>${message}`;
      if (type === 'success') {
        setTimeout(() => {
          alertElement.classList.remove('show');
          setTimeout(() => {
            if (notificationElement.parentNode) {
              notificationElement.remove();
            }
          }, 50);
        }, 500);
      }
    }

    function showNotification(type, message) {
      const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
      }[type] || 'alert-info';
      
      const iconClass = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-exclamation-triangle-fill',
        'warning': 'bi-exclamation-circle-fill',
        'info': 'bi-info-circle-fill'
      }[type] || 'bi-info-circle-fill';
      
      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          <i class="bi ${iconClass} me-2"></i>${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      
      const alertContainer = document.createElement('div');
      alertContainer.className = 'position-fixed top-0 start-0 end-0 p-3 text-center';
      alertContainer.style.zIndex = '5000';
      alertContainer.innerHTML = alertHtml;
      document.body.appendChild(alertContainer);
      
      const timeout = (type === 'success' || type === 'info') ? 500 : 1000;
      
      setTimeout(() => {
        if (alertContainer.parentNode) {
          alertContainer.querySelector('.alert').classList.remove('show');
          setTimeout(() => alertContainer.remove(), 50);
        }
      }, timeout);
    }

    function findPlaceInRecommendations(placeId) {
      for (const dayIndex in itineraryRecommendations) {
        for (const place of itineraryRecommendations[dayIndex]) {
          if (place.place_id === placeId) {
            return place;
          }
        }
      }
      return null;
    }

    function addToItineraryForDay(place, dayIndex) {
      const payload = {
        placeId: place.placeId,
        name: place.name,
        address: place.address,
        category: 'attraction',
        notes: place.notes,
        indoor: place.indoor,
        dayIndex: dayIndex
      };
      
      fetch('/api/plan/places', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        showResultNotification(data, place.name, dayIndex);
      })
      .catch(error => {
        console.error('Error adding to itinerary:', error);
        alert('Error adding to itinerary. Please try again later.');
      });
    }

    function addToItineraryWithoutDay(place) {
      fetch('/api/plan/places', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          placeId: place.placeId,
          name: place.name,
          address: place.address,
          category: 'attraction',
          notes: place.notes,
          indoor: place.indoor
        })
      })
      .then(response => response.json())
      .then(data => {
        showResultNotification(data, place.name);
      })
      .catch(error => {
        console.error('Error adding to itinerary:', error);
        alert('Error adding to itinerary. Please try again later.');
      });
    }

    function showResultNotification(data, placeName, dayIndex) {
      let alertClass = 'alert-success';
      let dayMessage = dayIndex !== undefined ? ` for Day ${dayIndex + 1}` : '';
      let alertMessage = `<strong>Success!</strong> "${placeName}" added to your itinerary${dayMessage}.`;
      
      if (data.duplicate) {
        alertClass = 'alert-warning';
        alertMessage = `<strong>Note:</strong> ${data.message}`;
      }
      
      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
          ${alertMessage}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      
      const alertContainer = document.createElement('div');
      alertContainer.className = 'position-fixed top-0 start-0 end-0 p-3 text-center';
      alertContainer.style.zIndex = '5000';
      alertContainer.innerHTML = alertHtml;
      document.body.appendChild(alertContainer);
      
      setTimeout(() => {
        if (alertContainer.parentNode) {
          alertContainer.querySelector('.alert').classList.remove('show');
          setTimeout(() => alertContainer.remove(), 300);
        }
      }, 3000);
    }

    function addToItinerary(placeId, dayIndex) {
      const place = itineraryRecommendations[dayIndex].find(p => p.place_id === placeId);
      if (!place) return;
      if (!checkAuthBeforeAddToItinerary(place)) return;
      fetch('/api/plan/places', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          placeId: place.place_id,
          name: place.name,
          address: place.formatted_address,
          category: 'attraction',
          notes: '',
          indoor: document.getElementById('indoor-toggle').checked,
          dayIndex: dayIndex
        })
      })
      .then(response => response.json())
      .then(data => {
        showResultNotification(data, place.name, dayIndex);
      })
      .catch(error => {
        console.error('Error adding to itinerary:', error);
        alert('Error adding to itinerary. Please try again later.');
      });
    }

    function loadGoogleMapsScript(apiKey) {
      // Create the script element
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
      script.async = true;
      script.defer = true;
      
      // Add the script to the document
      document.body.appendChild(script);
    }

    function loadCurrentPlan() {
      fetch('/api/plan')
        .then(response => response.json())
        .then(data => {
          if (data.plan && data.plan.destination) {
            currentPlan = data.plan;
            if (!currentPlan.perDayCityMap) {
              currentPlan.perDayCityMap = computePerDayCityMap(currentPlan);
              console.log('Computed perDayCityMap:', currentPlan.perDayCityMap);
            }
            document.getElementById('destination-display').textContent = currentPlan.destination;
            document.getElementById('date-display').textContent = formatDateRange(currentPlan.startDate, currentPlan.endDate);
            document.getElementById('current-plan-info').style.display = 'block';
            document.getElementById('no-plan-alert').style.display = 'none';
            generateItineraryTabs();
            const dayCount = currentPlan.perDayCityMap.length;
            const fetchPromises = [];
            for (let i = 0; i < dayCount; i++) {
              const city = currentPlan.perDayCityMap[i];
              const promise = fetch(`/api/places?location=${encodeURIComponent(city)}&type=attraction`)
                .then(res => res.json())
                .then(result => {
                  itineraryRecommendations[i] = result.results || [];
                });
              fetchPromises.push(promise);
            }
            Promise.all(fetchPromises).then(() => {
              // Remove duplicate recommended attractions for the same city across days.
              const cityUsed = {};
              for (let i = 0; i < currentPlan.perDayCityMap.length; i++) {
                const city = currentPlan.perDayCityMap[i];
                if (!cityUsed[city]) {
                  cityUsed[city] = new Set();
                }
                itineraryRecommendations[i] = (itineraryRecommendations[i] || []).filter(place => {
                  return !cityUsed[city].has(place.place_id);
                });
                itineraryRecommendations[i] = filterRecommendations(itineraryRecommendations[i], 5, 5);
                itineraryRecommendations[i].forEach(place => {
                  cityUsed[city].add(place.place_id);
                });
              }
              generateItineraryTabs();
              createRecommendedMarkers();
              
              if (currentPlan.perDayCityMap.length > 0) {
                const firstCity = currentPlan.perDayCityMap[0];
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: firstCity }, (results, status) => {
                  if (status === 'OK' && results[0]) {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(12);
                  }
                });
                originalSearchAttractions('', firstCity);
              }
            });
            fetch(`/api/weather?city=${encodeURIComponent(currentPlan.destination)}`)
              .then(res => res.json())
              .then(weather => {
                rainDays = weather.rainDays || [];
              })
              .catch(err => {
                console.error('Failed to fetch weather:', err);
              });
          } else {
            document.getElementById('no-plan-alert').style.display = 'block';
            document.getElementById('current-plan-info').style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error loading plan:', error);
          document.getElementById('no-plan-alert').style.display = 'block';
        });
    }

    function checkAuthBeforeAddToItinerary(placeData) {
      const authUser = localStorage.getItem('authUser');
      if (!authUser) {
        showLoginRequiredModal();
        return false;
      }
      return true;
    }

    function showLoginRequiredModal() {
      const notificationHtml = `
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Authentication Required!</strong> You need to log in to add items to your itinerary.
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      const notificationContainer = document.createElement('div');
      notificationContainer.className = 'position-fixed top-0 start-0 end-0 p-3 text-center';
      notificationContainer.style.zIndex = '5000';
      notificationContainer.innerHTML = notificationHtml;
      document.body.appendChild(notificationContainer);
      setTimeout(() => {
        if (notificationContainer.parentNode) {
          notificationContainer.querySelector('.alert').classList.remove('show');
          setTimeout(() => notificationContainer.remove(), 300);
        }
      }, 5000);
      const modalHtml = `
        <div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-labelledby="loginRequiredModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="loginRequiredModalLabel">
                  <i class="bi bi-shield-lock me-2"></i>Login Required
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p class="lead">You need to be logged in to add places to your itinerary.</p>
                <p>Would you like to log in now?</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="https://us-east-1zjt65d7ot.auth.us-east-1.amazoncognito.com/login?client_id=3anj5rhtknc7i97jq3jgknai71&response_type=code&scope=email+openid+phone&redirect_uri=http%3A%2F%2Flocalhost%3A3000" class="btn btn-warning">
                  <i class="bi bi-box-arrow-in-right me-1"></i>Login
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
      if (!document.getElementById('loginRequiredModal')) {
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer.firstChild);
      }
      setTimeout(() => {
        const loginModal = new bootstrap.Modal(document.getElementById('loginRequiredModal'));
        loginModal.show();
      }, 500);
    }

    function createRecommendedMarkers() {
      // Remove old recommended markers
      recommendedMarkers.forEach(obj => obj.marker.setMap(null));
      recommendedMarkers = [];
      
      // Clear and rebuild the recommended place ID set
      recommendedPlaceIds.clear();

      // Loop over each day’s recommended places
      for (let dayIndex = 0; dayIndex < currentPlan.perDayCityMap.length; dayIndex++) {
        const recs = itineraryRecommendations[dayIndex] || [];
        recs.forEach(place => {
          if (!place.geometry || !place.geometry.location) return;
          
          // Add place_id to the set so we know it's recommended
          recommendedPlaceIds.add(place.place_id);
          
          // Create the recommended (blue) marker
          const marker = new google.maps.Marker({
            position: place.geometry.location,
            map: map,
            title: place.name,
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            zIndex: 999
          });
          
          // **Attach the same click handler** so that clicking the blue marker shows the details modal
          marker.addListener('click', () => showPlaceDetails(place));
          
          // Store both the marker and which day it belongs to
          recommendedMarkers.push({ marker, dayIndex });
        });
      }
    }

    function displayResults(places) {
  const resultsContainer = document.getElementById('results-container');
  resultsContainer.innerHTML = '';

  places.forEach((place) => {
    // Add map marker if not a recommended place
    if (!recommendedPlaceIds.has(place.place_id)) {
      const marker = new google.maps.Marker({
        position: place.geometry.location,
        map: map,
        title: place.name,
        animation: google.maps.Animation.DROP
      });
      searchMarkers.push(marker);
      marker.addListener('click', () => showPlaceDetails(place));
    }

    // Use Google photo if available, else fallback
    let photoUrl;
    if (place.photos && place.photos.length > 0) {
      const photoName = place.photos[0].name;
      photoUrl = `https://places.googleapis.com/v1/${photoName}/media?key=${apiKey}&maxWidthPx=600`;
    } else {
      photoUrl = '/assets/logo.png';
    }

    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4';
    col.style.opacity = 0;
    col.style.transition = 'opacity 0.3s ease-in-out';

    const card = document.createElement('div');
    card.className = 'card attraction-card h-100';

    card.innerHTML = `
      <div class="card-body">
        <h5 class="card-title">${place.name}</h5>
        <p class="card-text">
          ${place.rating ? `<span class="rating">★ ${place.rating}</span>` : ''}
        </p>
        <p class="card-text text-truncate">${place.formatted_address || ''}</p>
        <button class="btn btn-sm btn-outline-primary view-details-btn">View Details</button>
      </div>
    `;

    const image = new Image();
    image.src = photoUrl;
    image.alt = place.name;
    image.className = 'card-img-top attraction-image';
    image.style.display = 'none';

    // Insert image into card *before* it loads/fails
    card.insertBefore(image, card.firstChild);
    col.appendChild(card);
    resultsContainer.appendChild(col);

    // Image load success
    image.onload = () => {
      image.style.display = 'block';
      setTimeout(() => col.style.opacity = 1, 10);
    };

    // Image failed to load
    image.onerror = (e) => {
      console.warn(`⚠️ Failed to load image for "${place.name}" (Place ID: ${place.place_id})`);
      console.warn('Error event:', e);
      console.warn('Attempted image URL:', image.src);

      // Fallback to default image
      image.src = '/assets/logo.png';
      image.onload = () => {
        image.style.display = 'block';
        setTimeout(() => col.style.opacity = 1, 10);
      };
    };

    // Button click
    card.querySelector('.view-details-btn').addEventListener('click', () => {
      showPlaceDetails(place);
    });
  });
}



function showPlaceDetails(place) {
  selectedPlace = place;
  document.getElementById('modal-title').textContent = place.name;
  document.getElementById('modal-body').innerHTML = `
    <div class="text-center my-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading details...</p>
    </div>
  `;
  attractionModal.show();

  fetch(`/api/places/${place.place_id}`)
    .then(response => response.json())
    .then(data => {
      let photoUrl;

      if (place.photos && place.photos.length > 0) {
        const photoName = place.photos[0].name;
        photoUrl = `https://places.googleapis.com/v1/${photoName}/media?key=${apiKey}&maxWidthPx=600`;
      } else {
        photoUrl = `https://source.unsplash.com/600x400/?${encodeURIComponent(place.name)}`;
      }

      if (data.status === 'OK' && data.result) {
        const details = data.result;

        document.getElementById('modal-body').innerHTML = `
          <img src="${photoUrl}" alt="${place.name}" class="img-fluid rounded mb-3" style="max-height: 300px; object-fit: cover; width: 100%;">
          <div class="mb-4">
            <h4>${details.name}</h4>
            <p>${details.rating ? `<span class="rating">★ ${details.rating}</span>` : ''}</p>
            <p>${details.formatted_address || ''}</p>
            ${details.formatted_phone_number ? `<p><strong>Phone:</strong> ${details.formatted_phone_number}</p>` : ''}
            ${details.website ? `<p><strong>Website:</strong> <a href="${details.website}" target="_blank">${details.website}</a></p>` : ''}
          </div>
          ${details.description ? `
            <div class="mb-4">
              <h5>About</h5>
              <p>${details.description}</p>
            </div>
          ` : ''}
          ${details.opening_hours && details.opening_hours.weekday_text ? `
            <div class="mb-4">
              <h5>Opening Hours</h5>
              <ul class="list-unstyled">
                ${details.opening_hours.weekday_text.map(day => `<li>${day}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          <div class="mb-3">
            <h5>Add Notes</h5>
            <textarea id="place-notes" class="form-control" rows="3" placeholder="Add any notes about this place..."></textarea>
          </div>
        `;
      } else {
        document.getElementById('modal-body').innerHTML = `
          <div class="alert alert-warning">
            Could not load detailed information for this place.
          </div>
          <img src="${photoUrl}" alt="${place.name}" class="img-fluid rounded mb-3" style="max-height: 300px; object-fit: cover; width: 100%;">
          <div class="mb-3">
            <h4>${place.name}</h4>
            <p>${place.formatted_address || ''}</p>
          </div>
          <div class="mb-3">
            <h5>Add Notes</h5>
            <textarea id="place-notes" class="form-control" rows="3" placeholder="Add any notes about this place..."></textarea>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Error fetching place details:', error);
      document.getElementById('modal-body').innerHTML = `
        <div class="alert alert-danger">
          Error loading place details. Please try again later.
        </div>
      `;
    });
}


    function clearSearchMarkers() {
      // Only clear the "found" markers, NOT the recommended ones
      searchMarkers.forEach(marker => marker.setMap(null));
      searchMarkers = [];
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Call addDaySelectionModal to ensure the modal is created
      addDaySelectionModal();
      
      document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const keyword = document.getElementById('keyword').value;
        originalSearchAttractions(keyword);
      });
      
      // This is the crucial part to update - the save button handler
      document.getElementById('save-attraction-btn').addEventListener('click', function() {
        if (!selectedPlace) return;
        if (!checkAuthBeforeAddToItinerary(selectedPlace)) return;
        
        selectedPlaceForDaySelection = {
          placeId: selectedPlace.place_id,
          name: selectedPlace.name,
          address: selectedPlace.formatted_address || '',
          notes: document.getElementById('place-notes').value,
          indoor: document.getElementById('indoor-toggle').checked
        };
        
        // Hide the attraction details modal
        attractionModal.hide();
        
        // Check if the user has a trip with dates
        fetch('/api/plan')
          .then(response => response.json())
          .then(data => {
            if (data.plan && data.plan.startDate && data.plan.endDate) {
              // Show day selection if the trip has dates
              const startDate = new Date(data.plan.startDate);
              const endDate = new Date(data.plan.endDate);
              const dayCount = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
              
              // Update the place name in the modal
              document.getElementById('place-name-display').textContent = selectedPlaceForDaySelection.name;
              
              // Generate day selection buttons
              const buttonsContainer = document.getElementById('day-selection-buttons');
              buttonsContainer.innerHTML = '';
              
              for (let i = 0; i < dayCount; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                
                // Create a button for each day
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-primary';
                button.innerHTML = `Day ${i + 1} <small>(${currentDay.toLocaleDateString()})</small>`;
                button.dataset.dayIndex = i;
                
                // Add click handler for the button
                button.addEventListener('click', function() {
                  addToItineraryForDay(selectedPlaceForDaySelection, i);
                  const daySelectionModal = bootstrap.Modal.getInstance(document.getElementById('daySelectionModal'));
                  daySelectionModal.hide();
                });
                
                buttonsContainer.appendChild(button);
              }
              
              // Show the day selection modal
              const daySelectionModal = new bootstrap.Modal(document.getElementById('daySelectionModal'));
              daySelectionModal.show();
            } else {
              // If no dates, just add without day selection
              addToItineraryWithoutDay(selectedPlaceForDaySelection);
            }
          })
          .catch(error => {
            console.error('Error loading plan for day selection:', error);
            addToItineraryWithoutDay(selectedPlaceForDaySelection);
          });
      });
      
      document.getElementById('indoor-toggle').addEventListener('change', (e) => {
        const keywordInput = document.getElementById('keyword');
        if (e.target.checked) {
          keywordInput.value = 'indoors';
        } else {
          keywordInput.value = '';
        }
        originalSearchAttractions(keywordInput.value);
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/js/weather.js"></script>
  <script>
    fetch('/api/plan')
      .then(res => res.json())
      .then(data => {
        if (data.plan && data.plan.destination) {
          const { destination, startDate, endDate } = data.plan;
          fetch(`/api/weather?city=${encodeURIComponent(destination)}`)
            .then(res => res.json())
            .then(weatherData => {
              showWeatherForDateRange(weatherData.forecast, startDate, endDate, '.main-content');
            });
        }
      })
      .catch(err => console.error('Weather load error:', err));
  </script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const text = "Discover Attractions";
    const element = document.getElementById("typewriter-attractions");
    let index = 0;
  
    function type() {
      if (index < text.length) {
        element.textContent += text.charAt(index);
        index++;
        setTimeout(type, 100); // typing speed
      }
    }
  
    type();
  });
  </script>


  <script src="/js/auth.js"></script>

</body>
</html>
